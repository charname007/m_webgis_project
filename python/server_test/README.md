# SQL Query API 服务器

这是一个基于FastAPI的自然语言SQL查询API服务。

## 优化内容

### 1. 代码结构优化
- **清理导入语句**：移除了未使用的导入（`asyncio`, `gr`, `m_model`）
- **模块化组织**：将代码按功能模块化，提高可读性
- **常量定义**：将配置参数提取为常量
- **类型注解**：添加了完整的类型提示

### 2. 输入验证改进
- **更合理的验证逻辑**：允许常见标点符号，而不是只允许字母数字
- **长度限制**：从100字符增加到500字符，更符合实际使用
- **安全检查**：添加SQL注入防护检查
- **智能过滤**：检查无效字符比例，避免过度过滤

### 3. 错误处理优化
- **延迟初始化**：SQL查询代理在需要时才初始化，避免启动失败
- **详细的错误信息**：提供清晰的错误消息和状态码
- **日志记录**：添加完整的日志记录系统
- **资源清理**：应用关闭时正确清理资源

### 4. API设计改进
- **RESTful设计**：使用标准的HTTP方法和路径
- **文档完善**：添加了完整的API文档和参数说明
- **状态管理**：统一的响应格式包含状态信息

## 主要端点

### 健康检查
```
GET /
```

返回服务状态信息。

### 执行查询
```
GET /query/{query_text}
```

执行自然语言SQL查询。

## 使用方法

### 启动服务器
```bash
cd python
python server.py
```

### 环境变量
需要设置以下环境变量：
- `DEEPSEEK_API_KEY`: DeepSeek API密钥
- 数据库连接配置（在sql_connector.py中配置）

### 测试API
```bash
# 健康检查
curl http://localhost:8000/

# 执行查询
curl http://localhost:8000/query/查询所有用户
```

## 响应格式

### 成功响应
```json
{
  "result": "查询结果",
  "status": "success"
}
```

### 错误响应
```json
{
  "error": "错误消息",
  "details": "详细错误信息",
  "status": "error"
}
```

## 技术栈

- **框架**: FastAPI
- **LLM集成**: LangChain + DeepSeek
- **数据库**: PostgreSQL (通过SQLAlchemy)
- **服务器**: Uvicorn
- **日志**: Python logging

## 安全特性

- 输入验证和过滤
- SQL注入防护
- 请求长度限制
- 错误信息脱敏

## 性能优化

- 延迟初始化减少启动时间
- 线程池处理异步任务
- 连接池管理数据库连接
- 日志分级减少I/O开销
