<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.backend.be.mapper.DynamicTableMapper">

    <select id="getAllTableNames" resultType="string">
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = 'public'
          AND table_type = 'BASE TABLE'
          AND table_name NOT LIKE 'pg_%'
          AND table_name NOT LIKE 'sql_%'
    </select>

    <select id="tableExists" parameterType="string" resultType="boolean">
        SELECT COUNT(*)
        FROM information_schema.tables
        WHERE table_schema = 'public' AND table_name = #{tableName}
    </select>

    <select id="getTableData" parameterType="string" resultMap="mapResult">
        SELECT * FROM ${tableName} LIMIT 1000
    </select>

    <select id="getTableSchema" parameterType="string" resultMap="mapResult">
        SELECT column_name, data_type, is_nullable
        FROM information_schema.columns
        WHERE table_schema = 'public' AND table_name = #{tableName}
        ORDER BY ordinal_position
    </select>

    <select id='getSpatialTables' resultType="string">
        SELECT f_table_name
        FROM geometry_columns
        WHERE f_table_schema = 'public'
    </select>

    <resultMap id="mapResult" type="map">
        <id property="column_name" column="column_name"/>
        <result property="data_type" column="data_type"/>
        <result property="is_nullable" column="is_nullable"/>
    </resultMap>

<select id="getSpatialTableGeojson" parameterType="string" resultType="string">
    SELECT jsonb_build_object(
        'type', 'FeatureCollection',
        'features', jsonb_agg(
            jsonb_build_object(
                'type', 'Feature',
                'geometry', ST_AsGeoJSON(geom)::jsonb,
                'properties', to_jsonb(sub) - 'geom'
            )
        )
    ) AS geojson
    FROM (
        SELECT * 
        FROM ${tableName}
    ) AS sub
</select>

<select id="getSpatialTablesGeojson" parameterType="com.backend.be.model.SpatialTableRequest" resultType="string">
    SELECT jsonb_build_object(
        'type', 'FeatureCollection',
        'features', jsonb_agg(
            jsonb_build_object(
                'type', 'Feature',
                'geometry', ST_AsGeoJSON(geom)::jsonb,
                'properties', to_jsonb(sub) - 'geom'
            )
        )
    ) AS geojson
    FROM (
        SELECT * 
        FROM ${table}
        WHERE 1=1
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="categories != null and categories != ''">
            AND categories LIKE CONCAT('%', #{categories}, '%')
        </if>
        <if test="geom != null and geom != ''">
            <choose>
                <!-- 如果geom是点（以POINT开头） -->
                <when test="geom.startsWith('POINT')">
                    AND ST_Intersects(geom, ST_GeomFromText(#{geom}, 4326))
                </when>
                <!-- 如果geom是范围（以POLYGON、MULTIPOLYGON、LINESTRING、MULTILINESTRING开头） -->
                <when test="geom.startsWith('POLYGON') or geom.startsWith('MULTIPOLYGON') or geom.startsWith('LINESTRING') or geom.startsWith('MULTILINESTRING')">
                    AND ST_Intersects(geom, ST_GeomFromText(#{geom}, 4326))
                </when>
                <!-- 其他几何类型 -->
                <otherwise>
                    AND ST_Intersects(geom, ST_GeomFromText(#{geom}, 4326))
                </otherwise>
            </choose>
        </if>
    ) AS sub
</select>

</mapper>
