<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.backend.be.mapper.ASightMapper">

<select id="getSightGeojsonByExtentAndLevel" parameterType="com.backend.be.model.SightQueryRequest" resultType="string">
    SELECT jsonb_build_object(
        'type', 'FeatureCollection',
        'features', jsonb_agg(
            jsonb_build_object(
                'type', 'Feature',
                'geometry', ST_AsGeoJSON(ST_Transform(geom, 4326))::jsonb,
                'properties', to_jsonb(sub) - 'geom'
            )
        )
    ) AS geojson
    FROM (
        SELECT * 
        FROM a_sight
        WHERE (
        -- 有坐标的景区：检查是否在范围内
        (geom IS NOT NULL AND ST_Intersects(
            ST_Transform(geom, 4326),
            ST_MakeEnvelope(#{minLon}, #{minLat}, #{maxLon}, #{maxLat}, 4326)
        ))
        <!-- OR
        geom IS NULL -->
    )
        <if test="levels != null and levels.size() > 0">
            AND level IN
            <foreach collection="levels" item="level" open="(" separator="," close=")">
                #{level}
            </foreach>
        </if>
    ) AS sub
</select>

<update id="updateByName" parameterType="com.backend.be.model.ASight">
    UPDATE a_sight SET
        name = #{name},
        level = #{level},
        address = #{address},
        lng_gcj02 = #{lngGcj02},
        lat_gcj02 = #{latGcj02},
        lng_bd09 = #{lngBd09},
        lat_bd09 = #{latBd09},
        lng_wgs84 = #{lngWgs84},
        lat_wgs84 = #{latWgs84},
        geom = ST_SetSRID(ST_MakePoint(#{lngWgs84}, #{latWgs84}), 4326)
    WHERE name = #{name}
</update>

<!-- 根据名称部分更新景区信息（只更新非null字段） -->
<update id="updateByNameSelective" parameterType="com.backend.be.model.ASight">
    UPDATE a_sight
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="level != null">level = #{level},</if>
        <if test="address != null">address = #{address},</if>
        <if test="lngGcj02 != null">lng_gcj02 = #{lngGcj02},</if>
        <if test="latGcj02 != null">lat_gcj02 = #{latGcj02},</if>
        <if test="lngBd09 != null">lng_bd09 = #{lngBd09},</if>
        <if test="latBd09 != null">lat_bd09 = #{latBd09},</if>
        <if test="lngWgs84 != null">lng_wgs84 = #{lngWgs84},</if>
        <if test="latWgs84 != null">lat_wgs84 = #{latWgs84},</if>
        <if test="lngWgs84 != null and latWgs84 != null">
            geom = ST_SetSRID(ST_MakePoint(#{lngWgs84}, #{latWgs84}), 4326)
        </if>
    </set>
    WHERE name = #{name}
</update>

<insert id="insert" parameterType="com.backend.be.model.ASight">
    INSERT INTO a_sight (
        name, level, address,
        lng_gcj02, lat_gcj02, lng_bd09, lat_bd09,
        lng_wgs84, lat_wgs84, geom
    ) VALUES (
        #{name}, #{level}, #{address},
        #{lngGcj02}, #{latGcj02}, #{lngBd09}, #{latBd09},
        #{lngWgs84}, #{latWgs84},
        ST_SetSRID(ST_MakePoint(#{lngWgs84}, #{latWgs84}), 4326)
    )
</insert>

<delete id="deleteByName" parameterType="string">
    DELETE FROM a_sight WHERE name = #{name}
</delete>

</mapper>
