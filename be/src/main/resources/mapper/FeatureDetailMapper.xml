<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.backend.be.mapper.FeatureDetailMapper">

    <!-- 检查表是否存在 -->
    <select id="tableExists" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_name = #{tableName}
        )
    </select>

    <!-- 检查要素是否存在 -->
    <select id="featureExists" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 
            FROM ${tableName} 
            WHERE 
            <choose>
                <when test="tableName == 'map_elements'">
                    element_id = #{featureId}
                </when>
                <otherwise>
                    id = #{featureId}
                </otherwise>
            </choose>
        )
    </select>

    <!-- 获取要素详情 -->
    <select id="getFeatureDetail" resultType="java.util.Map">
        SELECT * 
        FROM ${tableName} 
        WHERE 
        <choose>
            <when test="tableName == 'map_elements'">
                element_id = #{featureId}
            </when>
            <otherwise>
                id = #{featureId}
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <!-- 获取表的主键字段名 -->
    <select id="getPrimaryKeyColumn" resultType="java.lang.String">
        SELECT kcu.column_name
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu
            ON tc.constraint_name = kcu.constraint_name
            AND tc.table_schema = kcu.table_schema
        WHERE tc.table_schema = 'public'
            AND tc.table_name = #{tableName}
            AND tc.constraint_type = 'PRIMARY KEY'
        LIMIT 1
    </select>

    <!-- 获取表的字段信息 -->
    <select id="getTableColumns" resultType="java.util.Map">
        SELECT 
            column_name,
            data_type,
            is_nullable,
            column_default,
            ordinal_position
        FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = #{tableName}
        ORDER BY ordinal_position
    </select>

</mapper>
