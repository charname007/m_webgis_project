<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合要素属性统计修复验证</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
        }
        .header p {
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }
        .map-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .info-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .info-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .info-item .label {
            font-weight: bold;
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .info-item .value {
            color: #2c3e50;
            font-size: 16px;
            font-weight: bold;
        }
        .test-results {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        .test-results h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .test-case {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #27ae60;
        }
        .test-case.failed {
            border-left-color: #e74c3c;
        }
        .test-case .title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-case .result {
            font-size: 14px;
        }
        .test-case .result.pass {
            color: #27ae60;
        }
        .test-case .result.fail {
            color: #e74c3c;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass {
            background-color: #27ae60;
        }
        .status-fail {
            background-color: #e74c3c;
        }
        .zoom-level-display {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>聚合要素属性统计修复验证</h1>
            <p>验证聚合要素属性统计只包含可见要素，而不是所有要素</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>当前缩放级别:</label>
                <div class="zoom-level-display" id="zoomLevel">10</div>
            </div>
            <div class="control-group">
                <label>测试缩放级别:</label>
                <select id="testZoom">
                    <option value="10">10 - 只显示5A级</option>
                    <option value="12">12 - 显示5A和4A级</option>
                    <option value="14">14 - 显示所有等级</option>
                </select>
            </div>
            <div class="control-group">
                <label>操作:</label>
                <button id="runTest" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    运行测试
                </button>
            </div>
        </div>

        <div class="map-container" id="map"></div>

        <div class="info-panel">
            <h3>图层信息</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">总要素数量</div>
                    <div class="value" id="totalFeatures">0</div>
                </div>
                <div class="info-item">
                    <div class="label">可见要素数量</div>
                    <div class="value" id="visibleFeatures">0</div>
                </div>
                <div class="info-item">
                    <div class="label">聚合要素数量</div>
                    <div class="value" id="clusterFeatures">0</div>
                </div>
                <div class="info-item">
                    <div class="label">等级分布</div>
                    <div class="value" id="levelDistribution">-</div>
                </div>
            </div>
        </div>

        <div class="test-results">
            <h3>测试结果</h3>
            <div id="testResults">
                <div class="test-case">
                    <div class="title">等待测试运行...</div>
                    <div class="result">请点击"运行测试"按钮开始验证</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import MapUtils from './src/components/mapUtils.js';

        // 测试数据 - 模拟不同等级的景区
        const testFeatures = [
            { level: '5A', name: '黄鹤楼', coordinates: [114.305, 30.5928] },
            { level: '5A', name: '东湖', coordinates: [114.415, 30.5558] },
            { level: '4A', name: '归元寺', coordinates: [114.255, 30.5628] },
            { level: '4A', name: '古琴台', coordinates: [114.275, 30.5528] },
            { level: '4A', name: '晴川阁', coordinates: [114.285, 30.5728] },
            { level: '3A', name: '长春观', coordinates: [114.315, 30.5428] },
            { level: '3A', name: '宝通寺', coordinates: [114.325, 30.5328] },
            { level: '3A', name: '起义门', coordinates: [114.295, 30.5228] }
        ];

        // 缩放级别配置
        const zoomConfig = {
            fieldName: 'level',
            fieldRange: {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },
                    { value: '4A', minZoom: 12 },
                    { value: '3A', minZoom: 14 }
                ]
            }
        };

        let mapUtils;
        let layer;

        // 初始化地图
        function initMap() {
            const mapContainer = document.getElementById('map');
            mapUtils = new MapUtils(mapContainer);
            mapUtils.addBaseLayer();

            // 创建基于缩放级别的图层
            layer = mapUtils.createZoomBasedVectorLayer(
                zoomConfig.fieldName,
                zoomConfig.fieldRange,
                '景区图层',
                { enableClustering: true }
            );

            // 添加测试要素
            const features = testFeatures.map(feature => {
                const olFeature = new ol.Feature({
                    geometry: new ol.geom.Point(feature.coordinates),
                    level: feature.level,
                    name: feature.name,
                    type: '景区'
                });
                return olFeature;
            });

            mapUtils.addFeaturesToZoomLayer(layer, features);

            // 监听缩放级别变化
            mapUtils.map.getView().on('change:resolution', updateInfoPanel);

            // 初始设置
            mapUtils.map.getView().setZoom(10);
            updateInfoPanel();

            // 初始化要素点击事件
            mapUtils.initFeatureClick();
        }

        // 更新信息面板
        function updateInfoPanel() {
            const currentZoom = mapUtils.map.getView().getZoom();
            document.getElementById('zoomLevel').textContent = currentZoom.toFixed(2);

            const clusterSource = layer.getSource();
            const clusterFeatures = clusterSource.getFeatures();

            // 统计总要素数量
            const allFeaturesSource = layer.get('allFeaturesSource');
            const totalFeatures = allFeaturesSource.getFeatures().length;
            document.getElementById('totalFeatures').textContent = totalFeatures;

            // 统计可见要素数量
            const visibleFeatures = allFeaturesSource.getFeatures().filter(feature => 
                feature.get('visible') !== false
            ).length;
            document.getElementById('visibleFeatures').textContent = visibleFeatures;

            // 统计聚合要素数量
            document.getElementById('clusterFeatures').textContent = clusterFeatures.length;

            // 统计等级分布
            const levelDistribution = {};
            clusterFeatures.forEach(clusterFeature => {
                const distribution = clusterFeature.get('levelDistribution');
                if (distribution) {
                    Object.keys(distribution).forEach(level => {
                        levelDistribution[level] = (levelDistribution[level] || 0) + distribution[level];
                    });
                }
            });

            const levelText = Object.entries(levelDistribution)
                .map(([level, count]) => `${level}: ${count}个`)
                .join(', ');
            document.getElementById('levelDistribution').textContent = levelText || '-';
        }

        // 运行测试
        function runTests() {
            const testZoom = parseInt(document.getElementById('testZoom').value);
            const testResults = document.getElementById('testResults');
            
            // 设置测试缩放级别
            mapUtils.map.getView().setZoom(testZoom);
            
            // 等待地图更新
            setTimeout(() => {
                const clusterSource = layer.getSource();
                const clusterFeatures = clusterSource.getFeatures();
                
                let testResultsHTML = '';
                
                // 测试1: 验证聚合要素属性统计
                const test1Result = testClusterProperties(clusterFeatures, testZoom);
                testResultsHTML += `
                    <div class="test-case ${test1Result.passed ? '' : 'failed'}">
                        <div class="title">
                            <span class="status-indicator ${test1Result.passed ? 'status-pass' : 'status-fail'}"></span>
                            聚合要素属性统计验证
                        </div>
                        <div class="result ${test1Result.passed ? 'pass' : 'fail'}">
                            ${test1Result.message}
                        </div>
                    </div>
                `;
                
                // 测试2: 验证等级分布正确性
                const test2Result = testLevelDistribution(clusterFeatures, testZoom);
                testResultsHTML += `
                    <div class="test-case ${test2Result.passed ? '' : 'failed'}">
                        <div class="title">
                            <span class="status-indicator ${test2Result.passed ? 'status-pass' : 'status-fail'}"></span>
                            等级分布正确性验证
                        </div>
                        <div class="result ${test2Result.passed ? 'pass' : 'fail'}">
                            ${test2Result.message}
                        </div>
                    </div>
                `;
                
                // 测试3: 验证可见要素数量
                const test3Result = testVisibleFeatureCount(clusterFeatures);
                testResultsHTML += `
                    <div class="test-case ${test3Result.passed ? '' : 'failed'}">
                        <div class="title">
                            <span class="status-indicator ${test3Result.passed ? 'status-pass' : 'status-fail'}"></span>
                            可见要素数量验证
                        </div>
                        <div class="result ${test3Result.passed ? 'pass' : 'fail'}">
                            ${test3Result.message}
                        </div>
                    </div>
                `;
                
                testResults.innerHTML = testResultsHTML;
                updateInfoPanel();
            }, 500);
        }

        // 测试聚合要素属性
        function testClusterProperties(clusterFeatures, testZoom) {
            let totalFeatureCount = 0;
            let hasInvalidFeatures = false;
            
            clusterFeatures.forEach(clusterFeature => {
                const featureCount = clusterFeature.get('featureCount');
                const levelDistribution = clusterFeature.get('levelDistribution');
                const actualFeatures = clusterFeature.get('features');
                
                if (featureCount && actualFeatures) {
                    totalFeatureCount += featureCount;
                    
                    // 检查属性统计是否与实际可见要素一致
                    const visibleFeatures = actualFeatures.filter(f => f.get('visible') !== false);
                    if (featureCount !== visibleFeatures.length) {
                        hasInvalidFeatures = true;
                        console.warn('聚合要素属性统计不一致:', {
                            featureCount,
                            visibleCount: visibleFeatures.length,
                            actualCount: actualFeatures.length
                        });
                    }
                }
            });
            
            if (hasInvalidFeatures) {
                return {
                    passed: false,
                    message: `❌ 发现聚合要素属性统计不一致，包含不可见要素`
                };
            } else {
                return {
                    passed: true,
                    message: `✅ 聚合要素属性统计正确，只包含可见要素`
                };
            }
        }

        // 测试等级分布
        function testLevelDistribution(clusterFeatures, testZoom) {
            const expectedLevels = getExpectedLevels(testZoom);
            let hasUnexpectedLevels = false;
            let unexpectedLevels = [];
            
            clusterFeatures.forEach(clusterFeature => {
                const levelDistribution = clusterFeature.get('levelDistribution');
                if (levelDistribution) {
                    Object.keys(levelDistribution).forEach(level => {
                        if (!expectedLevels.includes(level)) {
                            hasUnexpectedLevels = true;
                            if (!unexpectedLevels.includes(level)) {
                                unexpectedLevels.push(level);
                            }
                        }
                    });
                }
            });
            
            if (hasUnexpectedLevels) {
                return {
                    passed: false,
                    message: `❌ 发现不应该显示的等级: ${unexpectedLevels.join(', ')}`
                };
            } else {
                return {
                    passed: true,
                    message: `✅ 等级分布正确，只包含应该显示的等级: ${expectedLevels.join(', ')}`
                };
            }
        }

        // 测试可见要素数量
        function testVisibleFeatureCount(clusterFeatures) {
            let totalVisibleCount = 0;
            let totalActualCount = 0;
            
            clusterFeatures.forEach(clusterFeature => {
                const featureCount = clusterFeature.get('featureCount');
                const actualFeatures = clusterFeature.get('features');
                
                if (featureCount) {
                    totalVisibleCount += featureCount;
                }
                if (actualFeatures) {
                    totalActualCount += actualFeatures.length;
                }
            });
            
            if (totalVisibleCount === 0 && totalActualCount > 0) {
                return {
                    passed: false,
                    message: `❌ 聚合要素统计为0，但实际包含${totalActualCount}个要素`
                };
            } else {
                return {
                    passed: true,
                    message: `✅ 可见要素数量统计正确: ${totalVisibleCount}个`
                };
            }
        }

        // 获取期望显示的等级
        function getExpectedLevels(zoom) {
            if (zoom < 12) return ['5A'];
            if (zoom < 14) return ['5A', '4A'];
            return ['5A', '4A', '3A'];
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            
            document.getElementById('runTest').addEventListener('click', runTests);
            document.getElementById('testZoom').addEventListener('change', () => {
                const zoom = parseInt(document.getElementById('testZoom').value);
                mapUtils.map.getView().setZoom(zoom);
                updateInfoPanel();
            });
        });
    </script>
</body>
</html>
