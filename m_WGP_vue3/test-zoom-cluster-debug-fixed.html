<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于缩放级别的图层聚合要素过滤调试</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .zoom-info {
            font-weight: bold;
            color: #007bff;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>基于缩放级别的图层聚合要素过滤调试</h1>
    
    <div class="controls">
        <button onclick="setZoom(8)">缩放级别 8 (只显示5A)</button>
        <button onclick="setZoom(11)">缩放级别 11 (显示5A,4A)</button>
        <button onclick="setZoom(13)">缩放级别 13 (显示5A,4A,3A)</button>
        <button onclick="setZoom(15)">缩放级别 15 (显示5A,4A,3A,2A)</button>
        <button onclick="setZoom(17)">缩放级别 17 (显示所有等级)</button>
        <button onclick="refreshVisibility()">手动刷新可见性</button>
        <button onclick="debugInfo()">调试信息</button>
        <button onclick="checkClusterFeatures()">检查聚合要素</button>
    </div>

    <div id="map"></div>
    
    <div class="info">
        <div>当前缩放级别: <span id="currentZoom" class="zoom-info">-</span></div>
        <div>可见要素数量: <span id="visibleCount">-</span></div>
        <div>可见等级: <span id="visibleLevels">-</span></div>
        <div>聚合要素数量: <span id="clusterCount">-</span></div>
        <div>调试信息: <span id="debugInfo">-</span></div>
    </div>

    <div class="status" id="status">
        页面加载中...
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script>
        // 简化的 MapUtils 类，用于调试
        class SimpleMapUtils {
            constructor(target) {
                this.map = this.initMap(target);
                this.defaultCenter = [114.305, 30.5928];
                this.state = {};
            }

            initMap(target) {
                const view = new ol.View({
                    center: [114.305, 30.5928],
                    zoom: 15,
                    projection: "EPSG:4326",
                    maxZoom: 18,
                    minZoom: 3,
                });

                this.map = new ol.Map({
                    target: target,
                    layers: [],
                    view: view,
                    controls: [
                        new ol.control.MousePosition({
                            coordinateFormat: function (coordinate) {
                                return coordinate.map((coord) => coord.toFixed(2)).join(", ");
                            },
                        }),
                        new ol.control.ScaleLine({
                            units: "metric",
                        })
                    ],
                });

                return this.map;
            }

            addBaseLayer() {
                const layer = new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    title: "OpenStreetMap",
                    visible: true,
                });
                this.map.addLayer(layer);
                return layer;
            }

            // 创建基于缩放级别的图层
            createZoomBasedVectorLayer(fieldName, fieldRange, layerName, options = {}) {
                const defaultOptions = {
                    enableClustering: true,
                    clusterDistance: 40,
                    autoFitExtent: false
                };
                const finalOptions = { ...defaultOptions, ...options };

                // 创建两个数据源
                const allFeaturesSource = new ol.source.Vector();
                const visibleFeaturesSource = new ol.source.Vector();

                let finalSource = visibleFeaturesSource;
                if (finalOptions.enableClustering) {
                    finalSource = new ol.source.Cluster({
                        distance: finalOptions.clusterDistance,
                        source: visibleFeaturesSource
                    });
                }

                const layer = new ol.layer.Vector({
                    source: finalSource,
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 5,
                            fill: new ol.style.Fill({
                                color: '#4CAF50',
                            }),
                        }),
                    }),
                });

                // 存储数据源引用
                layer.set('allFeaturesSource', allFeaturesSource);
                layer.set('visibleFeaturesSource', visibleFeaturesSource);
                layer.set('title', layerName);
                layer.set('zoomBasedConfig', {
                    fieldName,
                    fieldRange,
                    options: finalOptions
                });

                this.map.addLayer(layer);

                // 设置缩放监听
                this.setupZoomListener(layer);

                console.log(`基于缩放级别的图层已创建: ${layerName}`);
                return layer;
            }

            setupZoomListener(layer) {
                const updateFeatureVisibility = () => {
                    this.updateFeatureVisibility(layer);
                };

                this.map.getView().on('change:resolution', updateFeatureVisibility);
                layer.set('zoomListener', updateFeatureVisibility);

                // 初始更新
                setTimeout(() => this.updateFeatureVisibility(layer), 100);
            }

            updateFeatureVisibility(layer) {
                const config = layer.get('zoomBasedConfig');
                const { fieldName, fieldRange } = config;
                const currentZoom = this.map.getView().getZoom();

                const allFeaturesSource = layer.get('allFeaturesSource');
                const visibleFeaturesSource = layer.get('visibleFeaturesSource');
                const features = allFeaturesSource.getFeatures();

                console.log(`[缩放监听] 当前缩放级别: ${currentZoom.toFixed(2)}, 要素总数: ${features.length}`);

                if (features.length === 0) {
                    console.log('[缩放监听] 图层中没有要素');
                    return;
                }

                let visibleCount = 0;
                let hiddenCount = 0;
                const visibleFeatures = [];

                // 遍历所有要素，更新可见性状态
                features.forEach((feature, index) => {
                    const fieldValue = feature.get(fieldName);
                    const shouldBeVisible = this.shouldFeatureBeVisible(fieldValue, fieldRange, currentZoom);

                    if (index < 3) {
                        console.log(`[要素${index}] 等级=${fieldValue}, 应该可见=${shouldBeVisible}`);
                    }

                    feature.set('visible', shouldBeVisible);

                    if (shouldBeVisible) {
                        visibleCount++;
                        visibleFeatures.push(feature);
                    } else {
                        hiddenCount++;
                    }
                });

                // 关键修复：确保聚合图层只包含可见要素
                if (visibleFeaturesSource) {
                    // 清除之前的可见要素
                    visibleFeaturesSource.clear();
                    
                    // 只添加当前可见的要素到聚合源
                    if (visibleFeatures.length > 0) {
                        visibleFeaturesSource.addFeatures(visibleFeatures);
                        console.log(`[聚合更新] 已将 ${visibleFeatures.length} 个可见要素添加到聚合源`);
                        
                        // 强制刷新聚合图层
                        const layerSource = layer.getSource();
                        if (layerSource instanceof ol.source.Cluster) {
                            layerSource.refresh();
                            console.log('[聚合更新] 聚合源已刷新');
                        }
                    } else {
                        console.log('[聚合更新] 没有可见要素，聚合源已清空');
                    }
                }

                console.log(`[缩放监听] 缩放级别 ${currentZoom.toFixed(2)}: ${visibleCount} 个要素可见, ${hiddenCount} 个要素隐藏`);
            }

            shouldFeatureBeVisible(fieldValue, fieldRange, currentZoom) {
                const { type } = fieldRange;

                if (type === 'discrete') {
                    const matchingConfig = fieldRange.values.find(config => 
                        config.value === fieldValue
                    );

                    if (matchingConfig) {
                        return currentZoom >= matchingConfig.minZoom;
                    }
                }

                return false;
            }

            // 添加 GeoJSON 数据到图层
            addGeoJsonToLayer(targetLayer, geoJson) {
                return new Promise((resolve) => {
                    try {
                        const allFeaturesSource = targetLayer.get('allFeaturesSource');
                        const format = new ol.format.GeoJSON();
                        const features = format.readFeatures(geoJson);
                        
                        allFeaturesSource.addFeatures(features);
                        
                        // 更新可见性
                        this.updateFeatureVisibility(targetLayer);
                        
                        resolve({
                            success: true,
                            addedCount: features.length
                        });
                    } catch (error) {
                        console.error('添加 GeoJSON 失败:', error);
                        resolve({
                            success: false,
                            error: error.message
                        });
                    }
                });
            }

            refreshZoomBasedLayerVisibility(layer) {
                this.updateFeatureVisibility(layer);
                console.log('已手动刷新图层可见性');
            }
        }

        // 全局变量
        let mapUtils;
        let zoomLayer;

        // 测试数据
        const testGeoJsonData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "黄鹤楼",
                        "level": "5A",
                        "description": "武汉著名景点"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.305, 30.5428]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "东湖风景区",
                        "level": "5A",
                        "description": "武汉东湖景区"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.415, 30.5528]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "归元寺",
                        "level": "4A",
                        "description": "武汉归元寺"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.255, 30.5628]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "古琴台",
                        "level": "4A",
                        "description": "武汉古琴台"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.285, 30.5728]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "晴川阁",
                        "level": "3A",
                        "description": "武汉晴川阁"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.295, 30.5828]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "户部巷",
                        "level": "3A",
                        "description": "武汉户部巷"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.305, 30.5928]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "江汉路",
                        "level": "2A",
                        "description": "武汉江汉路"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.285, 30.6028]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "昙华林",
                        "level": "2A",
                        "description": "武汉昙华林"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.315, 30.6128]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "小景点1",
                        "level": "1A",
                        "description": "小景点1"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.275, 30.6228]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "小景点2",
                        "level": "1A",
                        "description": "小景点2"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.325, 30.6328]
                    }
                }
            ]
        };

        // 初始化地图
        function initMap() {
            try {
                document.getElementById('status').textContent = '正在初始化地图...';
                mapUtils = new SimpleMapUtils('map');
                mapUtils.addBaseLayer();
                
                // 创建基于缩放级别的图层
                zoomLayer = mapUtils.createZoomBasedVectorLayer(
                    'level',
                    {
                        type: 'discrete',
                        values: [
                            { value: '5A', minZoom: 10 },
                            { value: '4A', minZoom: 12 },
                            { value: '3A', minZoom: 14 },
                            { value: '2A', minZoom: 16 },
                            { value: '1A', minZoom: 18 }
                        ]
                    },
                    '景区图层',
                    {
                        enableClustering: true,
                        clusterDistance: 40,
                        autoFitExtent: false
                    }
                );

                // 添加测试数据
                mapUtils.addGeoJsonToLayer(zoomLayer, testGeoJsonData).then(result => {
                    console.log('测试数据添加成功:', result);
                    document.getElementById('status').textContent = '地图初始化完成！';
                    updateInfo();
                });

                // 监听缩放变化
                mapUtils.map.getView().on('change:resolution', () => {
                    updateInfo();
                });

                // 初始更新
                setTimeout(updateInfo, 1000);
            } catch (error) {
                console.error('初始化地图失败:', error);
                document.getElementById('status').textContent = '初始化失败: ' + error.message;
            }
        }

        // 设置缩放级别
        function setZoom(zoom) {
            mapUtils.map.getView().setZoom(zoom);
            updateInfo();
        }

        // 手动刷新可见性
        function refreshVisibility() {
            if (zoomLayer) {
                mapUtils.refreshZoomBasedLayerVisibility(zoomLayer);
                updateInfo();
                document.getElementById('debugInfo').textContent = '已手动刷新可见性';
            }
        }

        // 检查聚合要素
        function checkClusterFeatures() {
            if (zoomLayer) {
                const clusterSource = zoomLayer.getSource();
                const clusterFeatures = clusterSource.getFeatures();
                
                const clusterInfo = clusterFeatures.map((feature, index) => {
                    const features = feature.get('features');
                    const size = features ? features.length : 1;
                    const levels = features ? [...new Set(features.map(f => f.get('level')))] : [feature.get('level')];
                    
                    return `聚合${index}: ${size}个要素, 等级: ${levels.join(',')}`;
                }).join('\n');
                
                document.getElementById('debugInfo').textContent = clusterInfo;
                console.log('聚合要素检查:', clusterInfo);
            }
        }

        // 更新信息显示
        function updateInfo() {
            const currentZoom = mapUtils.map.getView().getZoom();
            document.getElementById('currentZoom').textContent = currentZoom.toFixed(2);

            if (zoomLayer) {
                // 获取可见要素源
                const visibleFeaturesSource = zoomLayer.get('visibleFeaturesSource');
                const visibleFeatures = visibleFeaturesSource ? visibleFeaturesSource.getFeatures() : [];
                
                // 获取聚合源
                const clusterSource = zoomLayer.getSource();
                const clusterFeatures = clusterSource.getFeatures();

                // 统计可见等级
                const visibleLevels = new Set();
                let totalVisibleFeatures = 0;

                // 分析可见要素源
                visibleFeatures.forEach(feature => {
                    const level = feature.get('level');
                    if (level) {
                        visibleLevels.add(level);
                        totalVisibleFeatures++;
                    }
                });

                // 分析聚合要素
                clusterFeatures.forEach(feature => {
                    const clusterFeatures = feature.get('features');
                    if (clusterFeatures) {
                        clusterFeatures.forEach(clusterFeature => {
                            const level = clusterFeature.get('level');
                            if (level) {
                                visibleLevels.add(level);
                            }
                        });
                    } else {
                        const level = feature.get('level');
                        if (level) {
                            visibleLevels.add(level);
                        }
                    }
                });

                document.getElementById('visibleCount').textContent = totalVisibleFeatures;
                document.getElementById('visibleLevels').textContent = Array.from(visibleLevels).sort().join(', ');
                document.getElementById('clusterCount').textContent = clusterFeatures.length;
                
                console.log('调试信息:', {
                    currentZoom,
                    visibleFeaturesCount: visibleFeatures.length,
                    clusterFeaturesCount: clusterFeatures.length,
                    visibleLevels: Array.from(visibleLevels)
                });
            }
        }

        // 调试信息
        function debugInfo() {
            if (zoomLayer) {
                const allFeaturesSource = zoomLayer.get('allFeaturesSource');
                const visibleFeaturesSource = zoomLayer.get('visibleFeaturesSource');
                const clusterSource = zoomLayer.getSource();

                const allFeatures = allFeaturesSource ? allFeaturesSource.getFeatures() : [];
                const visibleFeatures = visibleFeaturesSource ? visibleFeaturesSource.getFeatures() : [];
                const clusterFeatures = clusterSource.getFeatures();

                const info = `
                    所有要素: ${allFeatures.length}
                    可见要素: ${visibleFeatures.length}
                    聚合要素: ${clusterFeatures.length}
                    当前缩放: ${mapUtils.map.getView().getZoom().toFixed(2)}
                `;

                document.getElementById('debugInfo').textContent = info;
                console.log('详细调试信息:', {
                    allFeatures: allFeatures.length,
                    visibleFeatures: visibleFeatures.length,
                    clusterFeatures: clusterFeatures.length,
                    allFeaturesLevels: allFeatures.map(f => f.get('level')),
                    visibleFeaturesLevels: visibleFeatures.map(f => f.get('level'))
                });
            }
        }

        // 页面加载完成后初始化
        window.onload = initMap;
    </script>
</body>
</html>
