<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšåˆæºé‡å»ºæœºåˆ¶éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            display: flex;
            min-height: 600px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #e0e0e0;
        }
        
        #testMap {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            width: 300px;
            padding: 20px;
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .zoom-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        
        .zoom-info h4 {
            margin: 0 0 10px;
            color: #2c3e50;
        }
        
        .zoom-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .test-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        .test-button:active {
            transform: translateY(0);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .test-button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .result-item.success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }
        
        .result-item.warning {
            border-left-color: #f39c12;
            background: #fef5e7;
        }
        
        .result-item.error {
            border-left-color: #e74c3c;
            background: #fdeaea;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .result-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #34495e;
        }
        
        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .legend-5A { background: #e74c3c; }
        .legend-4A { background: #e67e22; }
        .legend-3A { background: #f39c12; }
        .legend-2A { background: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èšåˆæºé‡å»ºæœºåˆ¶éªŒè¯æµ‹è¯•</h1>
            <p>éªŒè¯èšåˆæºåœ¨ç¼©æ”¾çº§åˆ«å˜åŒ–æ—¶æ˜¯å¦æ­£ç¡®é‡å»ºï¼Œç¡®ä¿åªåŒ…å«å¯è§è¦ç´ </p>
        </div>
        
        <div class="content">
            <div class="map-container">
                <div id="testMap"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h3>æµ‹è¯•æ§åˆ¶</h3>
                    
                    <div class="zoom-info">
                        <h4>å½“å‰ç¼©æ”¾çº§åˆ«</h4>
                        <p id="currentZoom">-</p>
                        <p id="visibleInfo">å¯è§è¦ç´ : -</p>
                    </div>
                    
                    <button class="test-button" onclick="runFullTest()">
                        ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(8)">
                        ğŸ” æµ‹è¯•ç¼©æ”¾çº§åˆ« 8
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(10)">
                        ğŸ” æµ‹è¯•ç¼©æ”¾çº§åˆ« 10
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(12)">
                        ğŸ” æµ‹è¯•ç¼©æ”¾çº§åˆ« 12
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(14)">
                        ğŸ” æµ‹è¯•ç¼©æ”¾çº§åˆ« 14
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(16)">
                        ğŸ” æµ‹è¯•ç¼©æ”¾çº§åˆ« 16
                    </button>
                    
                    <button class="test-button success" onclick="testSingleFeatureProperties()">
                        ğŸ“‹ æµ‹è¯•å•ä¸ªè¦ç´ å±æ€§ä¼ é€’
                    </button>
                </div>
                
                <div class="control-group">
                    <h3>æµ‹è¯•ç»“æœ</h3>
                    <div id="testResults" class="results">
                        <div class="result-item">
                            <div class="result-title">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                            <div class="result-details">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿è¡Œæµ‹è¯•</div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>æµ‹è¯•æ—¥å¿—</h3>
                    <div id="testLog" class="log-container">
                        <div class="log-entry log-info">æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª</div>
                    </div>
                </div>
                
                <div class="legend">
                    <h3>æ™¯åŒºç­‰çº§å›¾ä¾‹</h3>
                    <div class="legend-item">
                        <div class="legend-color legend-5A"></div>
                        <span>5Açº§æ™¯åŒº (ç¼©æ”¾â‰¥10å¯è§)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-4A"></div>
                        <span>4Açº§æ™¯åŒº (ç¼©æ”¾â‰¥12å¯è§)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-3A"></div>
                        <span>3Açº§æ™¯åŒº (ç¼©æ”¾â‰¥14å¯è§)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-2A"></div>
                        <span>2Açº§æ™¯åŒº (ç¼©æ”¾â‰¥16å¯è§)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import MapUtils from './src/components/mapUtils.js';
        
        let mapUtils;
        let zoomLayer;
        let currentTestResults = [];
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            const mapContainer = document.getElementById('testMap');
            mapUtils = new MapUtils(mapContainer);
            mapUtils.addBaseLayer();
            
            // åˆ›å»ºåŸºäºç¼©æ”¾çº§åˆ«çš„å›¾å±‚
            const fieldRange = {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },
                    { value: '4A', minZoom: 12 },
                    { value: '3A', minZoom: 14 },
                    { value: '2A', minZoom: 16 }
                ]
            };
            
            zoomLayer = mapUtils.createZoomBasedVectorLayer('level', fieldRange, 'æ™¯åŒºå›¾å±‚', {
                enableClustering: true,
                clusterDistance: 40
            });
            
            // æ·»åŠ æµ‹è¯•è¦ç´ 
            const testFeatures = [
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.305, 30.5928]
                    },
                    properties: {
                        name: 'é»„é¹¤æ¥¼',
                        level: '5A',
                        description: 'æ­¦æ±‰è‘—åæ™¯ç‚¹'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.315, 30.6028]
                    },
                    properties: {
                        name: 'ä¸œæ¹–',
                        level: '5A',
                        description: 'æ­¦æ±‰è‘—åæ¹–æ³Š'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.325, 30.6128]
                    },
                    properties: {
                        name: 'æ­¦æ±‰å¤§å­¦',
                        level: '4A',
                        description: 'è‘—åé«˜æ ¡'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.335, 30.6228]
                    },
                    properties: {
                        name: 'æˆ·éƒ¨å··',
                        level: '3A',
                        description: 'ç¾é£Ÿè¡—'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.345, 30.6328]
                    },
                    properties: {
                        name: 'æ±Ÿæ±‰è·¯',
                        level: '2A',
                        description: 'å•†ä¸šæ­¥è¡Œè¡—'
                    }
                }
            ];
            
            mapUtils.addGeoJsonToLayer(zoomLayer, {
                type: 'FeatureCollection',
                features: testFeatures
            }).then(result => {
                logMessage(`âœ… æµ‹è¯•è¦ç´ æ·»åŠ å®Œæˆ: ${result.addedCount} ä¸ªè¦ç´ `, 'success');
                updateZoomInfo();
            });
            
            // ç›‘å¬ç¼©æ”¾å˜åŒ–
            mapUtils.map.getView().on('change:resolution', () => {
                updateZoomInfo();
            });
            
            logMessage('ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ–å®Œæˆ', 'success');
        }
        
        // æ›´æ–°ç¼©æ”¾ä¿¡æ¯
        function updateZoomInfo() {
            const currentZoom = mapUtils.map.getView().getZoom().toFixed(2);
            document.getElementById('currentZoom').textContent = currentZoom;
            
            // è®¡ç®—å¯è§è¦ç´ æ•°é‡
            const source = zoomLayer.getSource();
            const features = source.getFeatures();
            let visibleCount = 0;
            
            features.forEach(clusterFeature => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    visibleCount += childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                }
            });
            
            document.getElementById('visibleInfo').textContent = `å¯è§è¦ç´ : ${visibleCount}`;
        }
        
        // æ·»åŠ æ—¥å¿—
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(title, details, type = 'info') {
            const resultsContainer = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${type}`;
            
            resultItem.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-details">${details}</div>
            `;
            
            resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
            currentTestResults.push({ title, details, type });
        }
        
        // æµ‹è¯•ç‰¹å®šç¼©æ”¾çº§åˆ«
        async function testZoomLevel(zoom) {
            logMessage(`ğŸ” å¼€å§‹æµ‹è¯•ç¼©æ”¾çº§åˆ« ${zoom}`, 'info');
            
            // è®¾ç½®ç¼©æ”¾çº§åˆ«
            mapUtils.map.getView().setZoom(zoom);
            
            // ç­‰å¾…èšåˆæºé‡å»ºå®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // è·å–èšåˆå›¾å±‚çš„æ•°æ®æº
            const clusterSource = zoomLayer.getSource();
            const clusterFeatures = clusterSource.getFeatures();
            
            logMessage(`èšåˆè¦ç´ æ•°é‡: ${clusterFeatures.length}`, 'info');
            
            // éªŒè¯æ¯ä¸ªèšåˆè¦ç´ çš„ç»„æˆ
            let totalVisibleCount = 0;
            let totalInvisibleCount = 0;
            
            clusterFeatures.forEach((clusterFeature, index) => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    const visibleChildCount = childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                    
                    const invisibleChildCount = childFeatures.length - visibleChildCount;
                    totalVisibleCount += visibleChildCount;
                    totalInvisibleCount += invisibleChildCount;
                    
                    logMessage(`èšåˆè¦ç´  ${index}: ${childFeatures.length} ä¸ªå­è¦ç´ , ${visibleChildCount} ä¸ªå¯è§, ${invisibleChildCount} ä¸ªä¸å¯è§`, 'info');
                    
                    // éªŒè¯ä¸å¯è§è¦ç´ çš„ç­‰çº§
                    if (invisibleChildCount > 0) {
                        const invisibleLevels = {};
                        childFeatures.forEach(child => {
                            if (child.get('visible') === false) {
                                const level = child.get('level');
                                invisibleLevels[level] = (invisibleLevels[level] || 0) + 1;
                            }
                        });
                        logMessage(`âš ï¸ èšåˆè¦ç´  ${index} åŒ…å«ä¸å¯è§è¦ç´ : ${JSON.stringify(invisibleLevels)}`, 'warning');
                    }
                }
            });
            
            // éªŒè¯èšåˆæºé‡å»ºç»“æœ
            const expectedVisibleCount = getExpectedVisibleCount(zoom);
            
            logMessage(`é¢„æœŸå¯è§è¦ç´ : ${expectedVisibleCount}, å®é™…å¯è§è¦ç´ : ${totalVisibleCount}`, 'info');
            
            if (totalVisibleCount === expectedVisibleCount && totalInvisibleCount === 0) {
                logMessage(`âœ… ç¼©æ”¾çº§åˆ« ${zoom} èšåˆæºé‡å»ºéªŒè¯é€šè¿‡`, 'success');
                addTestResult(
                    `ç¼©æ”¾çº§åˆ« ${zoom} éªŒè¯é€šè¿‡`,
                    `é¢„æœŸå¯è§: ${expectedVisibleCount}, å®é™…å¯è§: ${totalVisibleCount}, ä¸å¯è§è¦ç´ : ${totalInvisibleCount}`,
                    'success'
                );
            } else {
                logMessage(`âŒ ç¼©æ”¾çº§åˆ« ${zoom} èšåˆæºé‡å»ºéªŒè¯å¤±è´¥`, 'error');
                addTestResult(
                    `ç¼©æ”¾çº§åˆ« ${zoom} éªŒè¯å¤±è´¥`,
                    `é¢„æœŸå¯è§: ${expectedVisibleCount}, å®é™…å¯è§: ${totalVisibleCount}, ä¸å¯è§è¦ç´ : ${totalInvisibleCount}`,
                    'error'
                );
            }
            
            updateZoomInfo();
        }
        
        // è·å–é¢„æœŸå¯è§è¦ç´ æ•°é‡
        function getExpectedVisibleCount(zoom) {
            const fieldRange = {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },
                    { value: '4A', minZoom: 12 },
                    { value: '3A', minZoom: 14 },
                    { value: '2A', minZoom: 16 }
                ]
            };
            
            const testFeatures = [
                { properties: { level: '5A' } },
                { properties: { level: '5A' } },
                { properties: { level: '4A' } },
                { properties: { level: '3A' } },
                { properties: { level: '2A' } }
            ];
            
            let count = 0;
            testFeatures.forEach(feature => {
                const level = feature.properties.level;
                const config = fieldRange.values.find(c => c.value === level);
                if (config && zoom >= config.minZoom) {
                    count++;
                }
            });
            
            return count;
        }
        
        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            logMessage('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•', 'info');
            
            const testZooms = [8, 10, 12, 14, 16];
            let passedTests = 0;
            let failedTests = 0;
            
            for (const zoom of testZooms) {
                await testZoomLevel(zoom);
                
                // æ£€æŸ¥æœ€åä¸€ä¸ªæµ‹è¯•ç»“æœ
                if (currentTestResults.length > 0) {
                    const lastResult = currentTestResults[0];
                    if (lastResult.type === 'success') {
                        passedTests++;
                    } else {
                        failedTests++;
                    }
                }
                
                // ç­‰å¾…ä¸€ä¸‹å†è¿›è¡Œä¸‹ä¸€ä¸ªæµ‹è¯•
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // æµ‹è¯•å•ä¸ªè¦ç´ å±æ€§ä¼ é€’
            await testSingleFeatureProperties();
            
            logMessage(`ğŸ“Š å®Œæ•´æµ‹è¯•å®Œæˆ: ${passedTests} ä¸ªé€šè¿‡, ${failedTests} ä¸ªå¤±è´¥`, 
                      failedTests === 0 ? 'success' : 'error');
        }
        
        // æµ‹è¯•å•ä¸ªè¦ç´ å±æ€§ä¼ é€’
        async function testSingleFeatureProperties() {
            logMessage('ğŸ“‹ å¼€å§‹æµ‹è¯•å•ä¸ªè¦ç´ èšåˆå±æ€§ä¼ é€’', 'info');
            
            // è®¾ç½®åˆ°é«˜ç¼©æ”¾çº§åˆ«ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ª5Açº§è¦ç´ å¯è§
            mapUtils.map.getView().setZoom(16);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const clusterSource = zoomLayer.getSource();
            const clusterFeatures = clusterSource.getFeatures();
            
            // æŸ¥æ‰¾å•ä¸ªè¦ç´ çš„èšåˆ
            const singleFeatureClusters = clusterFeatures.filter(cluster => {
                const childFeatures = cluster.get('features');
                return childFeatures && childFeatures.length === 1;
            });
            
            if (singleFeatureClusters.length > 0) {
                const singleCluster = singleFeatureClusters[0];
                const processedCluster = mapUtils.ensureSingleClusterFeatureProperties(singleCluster);
                
                logMessage('å•ä¸ªèšåˆè¦ç´ å±æ€§: ' + JSON.stringify(processedCluster.getProperties()), 'info');
                
                // éªŒè¯å±æ€§æ˜¯å¦æ­£ç¡®ä¼ é€’
                const originalFeature = singleCluster.get('features')[0];
                const originalProperties = originalFeature.getProperties();
                const clusterProperties = processedCluster.getProperties();
                
                const nameMatch = clusterProperties.name === originalProperties.name;
                const levelMatch = clusterProperties.level === originalProperties.level;
                
                if (nameMatch && levelMatch) {
                    logMessage('âœ… å•ä¸ªè¦ç´ èšåˆå±æ€§ä¼ é€’éªŒè¯é€šè¿‡', 'success');
                    addTestResult(
                        'å•ä¸ªè¦ç´ å±æ€§ä¼ é€’éªŒè¯é€šè¿‡',
                        `åç§°åŒ¹é…: ${nameMatch}, ç­‰çº§åŒ¹é…: ${levelMatch}`,
                        'success'
                    );
                } else {
                    logMessage('âŒ å•ä¸ªè¦ç´ èšåˆå±æ€§ä¼ é€’éªŒè¯å¤±è´¥', 'error');
                    addTestResult(
                        'å•ä¸ªè¦ç´ å±æ€§ä¼ é€’éªŒè¯å¤±è´¥',
                        `åç§°åŒ¹é…: ${nameMatch}, ç­‰çº§åŒ¹é…: ${levelMatch}`,
                        'error'
                    );
                }
            } else {
                logMessage('âš ï¸ æœªæ‰¾åˆ°å•ä¸ªè¦ç´ çš„èšåˆè¿›è¡Œæµ‹è¯•', 'warning');
                addTestResult(
                    'å•ä¸ªè¦ç´ å±æ€§ä¼ é€’æµ‹è¯•è·³è¿‡',
                    'æœªæ‰¾åˆ°å•ä¸ªè¦ç´ çš„èšåˆ',
                    'warning'
                );
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
