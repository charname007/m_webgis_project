<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合源重建机制验证测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            display: flex;
            min-height: 600px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #e0e0e0;
        }
        
        #testMap {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            width: 300px;
            padding: 20px;
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .zoom-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        
        .zoom-info h4 {
            margin: 0 0 10px;
            color: #2c3e50;
        }
        
        .zoom-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .test-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        .test-button:active {
            transform: translateY(0);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .test-button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .result-item.success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }
        
        .result-item.warning {
            border-left-color: #f39c12;
            background: #fef5e7;
        }
        
        .result-item.error {
            border-left-color: #e74c3c;
            background: #fdeaea;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .result-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #34495e;
        }
        
        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .legend-5A { background: #e74c3c; }
        .legend-4A { background: #e67e22; }
        .legend-3A { background: #f39c12; }
        .legend-2A { background: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>聚合源重建机制验证测试</h1>
            <p>验证聚合源在缩放级别变化时是否正确重建，确保只包含可见要素</p>
        </div>
        
        <div class="content">
            <div class="map-container">
                <div id="testMap"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h3>测试控制</h3>
                    
                    <div class="zoom-info">
                        <h4>当前缩放级别</h4>
                        <p id="currentZoom">-</p>
                        <p id="visibleInfo">可见要素: -</p>
                    </div>
                    
                    <button class="test-button" onclick="runFullTest()">
                        🚀 运行完整测试
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(8)">
                        🔍 测试缩放级别 8
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(10)">
                        🔍 测试缩放级别 10
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(12)">
                        🔍 测试缩放级别 12
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(14)">
                        🔍 测试缩放级别 14
                    </button>
                    
                    <button class="test-button warning" onclick="testZoomLevel(16)">
                        🔍 测试缩放级别 16
                    </button>
                    
                    <button class="test-button success" onclick="testSingleFeatureProperties()">
                        📋 测试单个要素属性传递
                    </button>
                </div>
                
                <div class="control-group">
                    <h3>测试结果</h3>
                    <div id="testResults" class="results">
                        <div class="result-item">
                            <div class="result-title">等待测试开始...</div>
                            <div class="result-details">点击上方按钮运行测试</div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>测试日志</h3>
                    <div id="testLog" class="log-container">
                        <div class="log-entry log-info">测试环境已准备就绪</div>
                    </div>
                </div>
                
                <div class="legend">
                    <h3>景区等级图例</h3>
                    <div class="legend-item">
                        <div class="legend-color legend-5A"></div>
                        <span>5A级景区 (缩放≥10可见)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-4A"></div>
                        <span>4A级景区 (缩放≥12可见)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-3A"></div>
                        <span>3A级景区 (缩放≥14可见)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-2A"></div>
                        <span>2A级景区 (缩放≥16可见)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import MapUtils from './src/components/mapUtils.js';
        
        let mapUtils;
        let zoomLayer;
        let currentTestResults = [];
        
        // 初始化地图
        function initMap() {
            const mapContainer = document.getElementById('testMap');
            mapUtils = new MapUtils(mapContainer);
            mapUtils.addBaseLayer();
            
            // 创建基于缩放级别的图层
            const fieldRange = {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },
                    { value: '4A', minZoom: 12 },
                    { value: '3A', minZoom: 14 },
                    { value: '2A', minZoom: 16 }
                ]
            };
            
            zoomLayer = mapUtils.createZoomBasedVectorLayer('level', fieldRange, '景区图层', {
                enableClustering: true,
                clusterDistance: 40
            });
            
            // 添加测试要素
            const testFeatures = [
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.305, 30.5928]
                    },
                    properties: {
                        name: '黄鹤楼',
                        level: '5A',
                        description: '武汉著名景点'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.315, 30.6028]
                    },
                    properties: {
                        name: '东湖',
                        level: '5A',
                        description: '武汉著名湖泊'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.325, 30.6128]
                    },
                    properties: {
                        name: '武汉大学',
                        level: '4A',
                        description: '著名高校'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.335, 30.6228]
                    },
                    properties: {
                        name: '户部巷',
                        level: '3A',
                        description: '美食街'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [114.345, 30.6328]
                    },
                    properties: {
                        name: '江汉路',
                        level: '2A',
                        description: '商业步行街'
                    }
                }
            ];
            
            mapUtils.addGeoJsonToLayer(zoomLayer, {
                type: 'FeatureCollection',
                features: testFeatures
            }).then(result => {
                logMessage(`✅ 测试要素添加完成: ${result.addedCount} 个要素`, 'success');
                updateZoomInfo();
            });
            
            // 监听缩放变化
            mapUtils.map.getView().on('change:resolution', () => {
                updateZoomInfo();
            });
            
            logMessage('🗺️ 地图初始化完成', 'success');
        }
        
        // 更新缩放信息
        function updateZoomInfo() {
            const currentZoom = mapUtils.map.getView().getZoom().toFixed(2);
            document.getElementById('currentZoom').textContent = currentZoom;
            
            // 计算可见要素数量
            const source = zoomLayer.getSource();
            const features = source.getFeatures();
            let visibleCount = 0;
            
            features.forEach(clusterFeature => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    visibleCount += childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                }
            });
            
            document.getElementById('visibleInfo').textContent = `可见要素: ${visibleCount}`;
        }
        
        // 添加日志
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 添加测试结果
        function addTestResult(title, details, type = 'info') {
            const resultsContainer = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${type}`;
            
            resultItem.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-details">${details}</div>
            `;
            
            resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
            currentTestResults.push({ title, details, type });
        }
        
        // 测试特定缩放级别
        async function testZoomLevel(zoom) {
            logMessage(`🔍 开始测试缩放级别 ${zoom}`, 'info');
            
            // 设置缩放级别
            mapUtils.map.getView().setZoom(zoom);
            
            // 等待聚合源重建完成
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 获取聚合图层的数据源
            const clusterSource = zoomLayer.getSource();
            const clusterFeatures = clusterSource.getFeatures();
            
            logMessage(`聚合要素数量: ${clusterFeatures.length}`, 'info');
            
            // 验证每个聚合要素的组成
            let totalVisibleCount = 0;
            let totalInvisibleCount = 0;
            
            clusterFeatures.forEach((clusterFeature, index) => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    const visibleChildCount = childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                    
                    const invisibleChildCount = childFeatures.length - visibleChildCount;
                    totalVisibleCount += visibleChildCount;
                    totalInvisibleCount += invisibleChildCount;
                    
                    logMessage(`聚合要素 ${index}: ${childFeatures.length} 个子要素, ${visibleChildCount} 个可见, ${invisibleChildCount} 个不可见`, 'info');
                    
                    // 验证不可见要素的等级
                    if (invisibleChildCount > 0) {
                        const invisibleLevels = {};
                        childFeatures.forEach(child => {
                            if (child.get('visible') === false) {
                                const level = child.get('level');
                                invisibleLevels[level] = (invisibleLevels[level] || 0) + 1;
                            }
                        });
                        logMessage(`⚠️ 聚合要素 ${index} 包含不可见要素: ${JSON.stringify(invisibleLevels)}`, 'warning');
                    }
                }
            });
            
            // 验证聚合源重建结果
            const expectedVisibleCount = getExpectedVisibleCount(zoom);
            
            logMessage(`预期可见要素: ${expectedVisibleCount}, 实际可见要素: ${totalVisibleCount}`, 'info');
            
            if (totalVisibleCount === expectedVisibleCount && totalInvisibleCount === 0) {
                logMessage(`✅ 缩放级别 ${zoom} 聚合源重建验证通过`, 'success');
                addTestResult(
                    `缩放级别 ${zoom} 验证通过`,
                    `预期可见: ${expectedVisibleCount}, 实际可见: ${totalVisibleCount}, 不可见要素: ${totalInvisibleCount}`,
                    'success'
                );
            } else {
                logMessage(`❌ 缩放级别 ${zoom} 聚合源重建验证失败`, 'error');
                addTestResult(
                    `缩放级别 ${zoom} 验证失败`,
                    `预期可见: ${expectedVisibleCount}, 实际可见: ${totalVisibleCount}, 不可见要素: ${totalInvisibleCount}`,
                    'error'
                );
            }
            
            updateZoomInfo();
        }
        
        // 获取预期可见要素数量
        function getExpectedVisibleCount(zoom) {
            const fieldRange = {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },
                    { value: '4A', minZoom: 12 },
                    { value: '3A', minZoom: 14 },
                    { value: '2A', minZoom: 16 }
                ]
            };
            
            const testFeatures = [
                { properties: { level: '5A' } },
                { properties: { level: '5A' } },
                { properties: { level: '4A' } },
                { properties: { level: '3A' } },
                { properties: { level: '2A' } }
            ];
            
            let count = 0;
            testFeatures.forEach(feature => {
                const level = feature.properties.level;
                const config = fieldRange.values.find(c => c.value === level);
                if (config && zoom >= config.minZoom) {
                    count++;
                }
            });
            
            return count;
        }
        
        // 运行完整测试
        async function runFullTest() {
            logMessage('🚀 开始运行完整测试', 'info');
            
            const testZooms = [8, 10, 12, 14, 16];
            let passedTests = 0;
            let failedTests = 0;
            
            for (const zoom of testZooms) {
                await testZoomLevel(zoom);
                
                // 检查最后一个测试结果
                if (currentTestResults.length > 0) {
                    const lastResult = currentTestResults[0];
                    if (lastResult.type === 'success') {
                        passedTests++;
                    } else {
                        failedTests++;
                    }
                }
                
                // 等待一下再进行下一个测试
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // 测试单个要素属性传递
            await testSingleFeatureProperties();
            
            logMessage(`📊 完整测试完成: ${passedTests} 个通过, ${failedTests} 个失败`, 
                      failedTests === 0 ? 'success' : 'error');
        }
        
        // 测试单个要素属性传递
        async function testSingleFeatureProperties() {
            logMessage('📋 开始测试单个要素聚合属性传递', 'info');
            
            // 设置到高缩放级别，确保只有一个5A级要素可见
            mapUtils.map.getView().setZoom(16);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const clusterSource = zoomLayer.getSource();
            const clusterFeatures = clusterSource.getFeatures();
            
            // 查找单个要素的聚合
            const singleFeatureClusters = clusterFeatures.filter(cluster => {
                const childFeatures = cluster.get('features');
                return childFeatures && childFeatures.length === 1;
            });
            
            if (singleFeatureClusters.length > 0) {
                const singleCluster = singleFeatureClusters[0];
                const processedCluster = mapUtils.ensureSingleClusterFeatureProperties(singleCluster);
                
                logMessage('单个聚合要素属性: ' + JSON.stringify(processedCluster.getProperties()), 'info');
                
                // 验证属性是否正确传递
                const originalFeature = singleCluster.get('features')[0];
                const originalProperties = originalFeature.getProperties();
                const clusterProperties = processedCluster.getProperties();
                
                const nameMatch = clusterProperties.name === originalProperties.name;
                const levelMatch = clusterProperties.level === originalProperties.level;
                
                if (nameMatch && levelMatch) {
                    logMessage('✅ 单个要素聚合属性传递验证通过', 'success');
                    addTestResult(
                        '单个要素属性传递验证通过',
                        `名称匹配: ${nameMatch}, 等级匹配: ${levelMatch}`,
                        'success'
                    );
                } else {
                    logMessage('❌ 单个要素聚合属性传递验证失败', 'error');
                    addTestResult(
                        '单个要素属性传递验证失败',
                        `名称匹配: ${nameMatch}, 等级匹配: ${levelMatch}`,
                        'error'
                    );
                }
            } else {
                logMessage('⚠️ 未找到单个要素的聚合进行测试', 'warning');
                addTestResult(
                    '单个要素属性传递测试跳过',
                    '未找到单个要素的聚合',
                    'warning'
                );
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
