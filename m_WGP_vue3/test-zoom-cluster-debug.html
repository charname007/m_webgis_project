<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于缩放级别的图层聚合要素过滤调试</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .zoom-info {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>基于缩放级别的图层聚合要素过滤调试</h1>
    
    <div class="controls">
        <button onclick="setZoom(8)">缩放级别 8 (只显示5A)</button>
        <button onclick="setZoom(11)">缩放级别 11 (显示5A,4A)</button>
        <button onclick="setZoom(13)">缩放级别 13 (显示5A,4A,3A)</button>
        <button onclick="setZoom(15)">缩放级别 15 (显示5A,4A,3A,2A)</button>
        <button onclick="setZoom(17)">缩放级别 17 (显示所有等级)</button>
        <button onclick="refreshVisibility()">手动刷新可见性</button>
        <button onclick="debugInfo()">调试信息</button>
    </div>

    <div id="map"></div>
    
    <div class="info">
        <div>当前缩放级别: <span id="currentZoom" class="zoom-info">-</span></div>
        <div>可见要素数量: <span id="visibleCount">-</span></div>
        <div>可见等级: <span id="visibleLevels">-</span></div>
        <div>调试信息: <span id="debugInfo">-</span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script src="./src/components/mapUtils.js"></script>
    <script>
        let mapUtils;
        let zoomLayer;

        // 测试数据
        const testGeoJsonData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "黄鹤楼",
                        "level": "5A",
                        "description": "武汉著名景点"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.305, 30.5428]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "东湖风景区",
                        "level": "5A",
                        "description": "武汉东湖景区"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.415, 30.5528]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "归元寺",
                        "level": "4A",
                        "description": "武汉归元寺"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.255, 30.5628]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "古琴台",
                        "level": "4A",
                        "description": "武汉古琴台"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.285, 30.5728]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "晴川阁",
                        "level": "3A",
                        "description": "武汉晴川阁"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.295, 30.5828]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "户部巷",
                        "level": "3A",
                        "description": "武汉户部巷"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.305, 30.5928]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "江汉路",
                        "level": "2A",
                        "description": "武汉江汉路"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.285, 30.6028]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "昙华林",
                        "level": "2A",
                        "description": "武汉昙华林"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.315, 30.6128]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "小景点1",
                        "level": "1A",
                        "description": "小景点1"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.275, 30.6228]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "小景点2",
                        "level": "1A",
                        "description": "小景点2"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.325, 30.6328]
                    }
                }
            ]
        };

        // 初始化地图
        function initMap() {
            mapUtils = new MapUtils('map');
            mapUtils.addBaseLayer();
            
            // 创建基于缩放级别的图层
            zoomLayer = mapUtils.createZoomBasedVectorLayer(
                'level',
                {
                    type: 'discrete',
                    values: [
                        { value: '5A', minZoom: 10 },
                        { value: '4A', minZoom: 12 },
                        { value: '3A', minZoom: 14 },
                        { value: '2A', minZoom: 16 },
                        { value: '1A', minZoom: 18 }
                    ]
                },
                '景区图层',
                {
                    enableClustering: true,
                    clusterDistance: 40,
                    autoFitExtent: false
                }
            );

            // 添加测试数据
            mapUtils.addGeoJsonToLayer(zoomLayer, testGeoJsonData).then(result => {
                console.log('测试数据添加成功:', result);
                updateInfo();
            });

            // 监听缩放变化
            mapUtils.map.getView().on('change:resolution', () => {
                updateInfo();
            });

            // 初始更新
            setTimeout(updateInfo, 1000);
        }

        // 设置缩放级别
        function setZoom(zoom) {
            mapUtils.map.getView().setZoom(zoom);
            updateInfo();
        }

        // 手动刷新可见性
        function refreshVisibility() {
            if (zoomLayer) {
                mapUtils.refreshZoomBasedLayerVisibility(zoomLayer);
                updateInfo();
                document.getElementById('debugInfo').textContent = '已手动刷新可见性';
            }
        }

        // 更新信息显示
        function updateInfo() {
            const currentZoom = mapUtils.map.getView().getZoom();
            document.getElementById('currentZoom').textContent = currentZoom.toFixed(2);

            if (zoomLayer) {
                // 获取可见要素源
                const visibleFeaturesSource = zoomLayer.get('visibleFeaturesSource');
                const visibleFeatures = visibleFeaturesSource ? visibleFeaturesSource.getFeatures() : [];
                
                // 获取聚合源
                const clusterSource = zoomLayer.getSource();
                const clusterFeatures = clusterSource.getFeatures();

                // 统计可见等级
                const visibleLevels = new Set();
                let totalVisibleFeatures = 0;

                // 分析可见要素源
                visibleFeatures.forEach(feature => {
                    const level = feature.get('level');
                    if (level) {
                        visibleLevels.add(level);
                        totalVisibleFeatures++;
                    }
                });

                // 分析聚合要素
                clusterFeatures.forEach(feature => {
                    const clusterFeatures = feature.get('features');
                    if (clusterFeatures) {
                        clusterFeatures.forEach(clusterFeature => {
                            const level = clusterFeature.get('level');
                            if (level) {
                                visibleLevels.add(level);
                            }
                        });
                    } else {
                        const level = feature.get('level');
                        if (level) {
                            visibleLevels.add(level);
                        }
                    }
                });

                document.getElementById('visibleCount').textContent = totalVisibleFeatures;
                document.getElementById('visibleLevels').textContent = Array.from(visibleLevels).sort().join(', ');
                
                console.log('调试信息:', {
                    currentZoom,
                    visibleFeaturesCount: visibleFeatures.length,
                    clusterFeaturesCount: clusterFeatures.length,
                    visibleLevels: Array.from(visibleLevels)
                });
            }
        }

        // 调试信息
        function debugInfo() {
            if (zoomLayer) {
                const allFeaturesSource = zoomLayer.get('allFeaturesSource');
                const visibleFeaturesSource = zoomLayer.get('visibleFeaturesSource');
                const clusterSource = zoomLayer.getSource();

                const allFeatures = allFeaturesSource ? allFeaturesSource.getFeatures() : [];
                const visibleFeatures = visibleFeaturesSource ? visibleFeaturesSource.getFeatures() : [];
                const clusterFeatures = clusterSource.getFeatures();

                const info = `
                    所有要素: ${allFeatures.length}
                    可见要素: ${visibleFeatures.length}
                    聚合要素: ${clusterFeatures.length}
                    当前缩放: ${mapUtils.map.getView().getZoom().toFixed(2)}
                `;

                document.getElementById('debugInfo').textContent = info;
                console.log('详细调试信息:', {
                    allFeatures: allFeatures.length,
                    visibleFeatures: visibleFeatures.length,
                    clusterFeatures: clusterFeatures.length,
                    allFeaturesLevels: allFeatures.map(f => f.get('level')),
                    visibleFeaturesLevels: visibleFeatures.map(f => f.get('level'))
                });
            }
        }

        // 页面加载完成后初始化
        window.onload = initMap;
    </script>
</body>
</html>
