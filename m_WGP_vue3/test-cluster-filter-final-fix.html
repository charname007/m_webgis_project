<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšåˆè¦ç´ è¿‡æ»¤æœ€ç»ˆä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>èšåˆè¦ç´ è¿‡æ»¤æœ€ç»ˆä¿®å¤æµ‹è¯•</h1>
    
    <div class="controls">
        <button onclick="testZoomLevel(9)">æµ‹è¯•ç¼©æ”¾çº§åˆ« 9</button>
        <button onclick="testZoomLevel(11)">æµ‹è¯•ç¼©æ”¾çº§åˆ« 11</button>
        <button onclick="testZoomLevel(13)">æµ‹è¯•ç¼©æ”¾çº§åˆ« 13</button>
        <button onclick="testZoomLevel(15)">æµ‹è¯•ç¼©æ”¾çº§åˆ« 15</button>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <span id="currentZoom">å½“å‰ç¼©æ”¾çº§åˆ«: -</span>
    </div>
    
    <div id="map"></div>
    
    <div class="log" id="log">
        <div>=== èšåˆè¦ç´ è¿‡æ»¤æœ€ç»ˆä¿®å¤æµ‹è¯• ===</div>
        <div>ç­‰å¾…åœ°å›¾åˆå§‹åŒ–...</div>
    </div>

    <script type="module">
        import MapUtils from './src/components/mapUtils.js';

        // æµ‹è¯•æ•°æ® - æ¨¡æ‹Ÿä¸åŒç­‰çº§çš„æ™¯åŒº
        const testFeatures = [
            {
                type: 'Feature',
                properties: {
                    name: '5Açº§æ™¯åŒº1',
                    level: '5A',
                    description: 'å›½å®¶çº§5Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.305, 30.5928]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '5Açº§æ™¯åŒº2',
                    level: '5A',
                    description: 'å›½å®¶çº§5Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.315, 30.6028]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '4Açº§æ™¯åŒº1',
                    level: '4A',
                    description: 'å›½å®¶çº§4Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.325, 30.6128]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '4Açº§æ™¯åŒº2',
                    level: '4A',
                    description: 'å›½å®¶çº§4Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.335, 30.6228]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '3Açº§æ™¯åŒº1',
                    level: '3A',
                    description: 'å›½å®¶çº§3Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.345, 30.6328]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '3Açº§æ™¯åŒº2',
                    level: '3A',
                    description: 'å›½å®¶çº§3Aæ™¯åŒº'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.355, 30.6428]
                }
            }
        ];

        // é…ç½®åŸºäºç¼©æ”¾çº§åˆ«çš„è¿‡æ»¤è§„åˆ™
        const zoomBasedConfig = {
            fieldName: 'level',
            fieldRange: {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },  // 5Açº§æ™¯åŒºåœ¨ç¼©æ”¾çº§åˆ«10+æ˜¾ç¤º
                    { value: '4A', minZoom: 12 },  // 4Açº§æ™¯åŒºåœ¨ç¼©æ”¾çº§åˆ«12+æ˜¾ç¤º
                    { value: '3A', minZoom: 14 }   // 3Açº§æ™¯åŒºåœ¨ç¼©æ”¾çº§åˆ«14+æ˜¾ç¤º
                ]
            }
        };

        let mapUtils;
        let zoomLayer;

        // åˆå§‹åŒ–åœ°å›¾
        async function initMap() {
            const mapContainer = document.getElementById('map');
            
            mapUtils = new MapUtils(mapContainer);
            mapUtils.addBaseLayer();
            
            // åˆ›å»ºåŸºäºç¼©æ”¾çº§åˆ«çš„å›¾å±‚
            zoomLayer = mapUtils.createZoomBasedVectorLayer(
                zoomBasedConfig.fieldName,
                zoomBasedConfig.fieldRange,
                'æ™¯åŒºå›¾å±‚',
                {
                    enableClustering: true,
                    clusterDistance: 40,
                    autoFitExtent: true
                }
            );
            
            // æ·»åŠ æµ‹è¯•è¦ç´ 
            const addResult = await mapUtils.addGeoJsonToLayer(zoomLayer, {
                type: 'FeatureCollection',
                features: testFeatures
            });
            
            log(`è¦ç´ æ·»åŠ ç»“æœ: ${addResult.addedCount} ä¸ªè¦ç´ å·²æ·»åŠ `);
            
            // ç›‘å¬ç¼©æ”¾çº§åˆ«å˜åŒ–
            mapUtils.map.getView().on('change:resolution', () => {
                const currentZoom = mapUtils.map.getView().getZoom();
                document.getElementById('currentZoom').textContent = `å½“å‰ç¼©æ”¾çº§åˆ«: ${currentZoom.toFixed(2)}`;
            });
            
            log('åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        }

        // æµ‹è¯•ç‰¹å®šç¼©æ”¾çº§åˆ«
        async function testZoomLevel(zoomLevel) {
            log(`\n--- æµ‹è¯•ç¼©æ”¾çº§åˆ« ${zoomLevel} ---`);
            
            // è®¾ç½®ç¼©æ”¾çº§åˆ«
            mapUtils.setCenter([114.305, 30.5928], zoomLevel, { animate: false });
            
            // ç­‰å¾…åœ°å›¾æ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // è·å–å½“å‰å¯è§è¦ç´ 
            const visibleCount = mapUtils.getVisibleFeatureCount(zoomLayer);
            log(`ç¼©æ”¾çº§åˆ« ${zoomLevel}: ${visibleCount} ä¸ªè¦ç´ å¯è§`);
            
            // éªŒè¯èšåˆè¦ç´ ç»„æˆ
            await validateClusterComposition(zoomLevel);
        }

        // éªŒè¯èšåˆè¦ç´ ç»„æˆ
        async function validateClusterComposition(currentZoom) {
            const source = zoomLayer.getSource();
            const clusterFeatures = source.getFeatures();
            
            log(`èšåˆè¦ç´ æ•°é‡: ${clusterFeatures.length}`);
            
            let totalInvisibleInClusters = 0;
            let validationPassed = true;
            
            clusterFeatures.forEach((clusterFeature, index) => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    const visibleChildCount = childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                    
                    const invisibleChildCount = childFeatures.length - visibleChildCount;
                    totalInvisibleInClusters += invisibleChildCount;
                    
                    if (invisibleChildCount > 0) {
                        log(`<span class="warning">âš ï¸ èšåˆè¦ç´  ${index} åŒ…å« ${invisibleChildCount} ä¸ªä¸å¯è§è¦ç´ </span>`);
                        
                        // æ˜¾ç¤ºä¸å¯è§è¦ç´ çš„è¯¦ç»†ä¿¡æ¯
                        const invisibleLevels = {};
                        childFeatures.forEach(child => {
                            if (child.get('visible') === false) {
                                const level = child.get('level');
                                invisibleLevels[level] = (invisibleLevels[level] || 0) + 1;
                            }
                        });
                        log(`<span class="warning">   ä¸å¯è§è¦ç´ ç­‰çº§åˆ†å¸ƒ: ${JSON.stringify(invisibleLevels)}</span>`);
                        validationPassed = false;
                    } else {
                        log(`<span class="success">âœ… èšåˆè¦ç´  ${index} å®Œå…¨ç”±å¯è§è¦ç´ ç»„æˆ</span>`);
                    }
                }
            });
            
            if (totalInvisibleInClusters > 0) {
                log(`<span class="error">âŒ å‘ç° ${totalInvisibleInClusters} ä¸ªä¸å¯è§è¦ç´ æ··å…¥èšåˆä¸­</span>`);
                validationPassed = false;
            } else {
                log(`<span class="success">âœ… æ‰€æœ‰èšåˆè¦ç´ å®Œå…¨ç”±å¯è§è¦ç´ ç»„æˆ</span>`);
            }
            
            return validationPassed;
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('\n=== å¼€å§‹å®Œæ•´æµ‹è¯• ===');
            
            const testZoomLevels = [9, 11, 13, 15];
            let allTestsPassed = true;
            
            for (const zoomLevel of testZoomLevels) {
                const testPassed = await testZoomLevel(zoomLevel);
                if (!testPassed) {
                    allTestsPassed = false;
                }
            }
            
            if (allTestsPassed) {
                log(`<span class="success">\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼èšåˆè¦ç´ è¿‡æ»¤ä¿®å¤æˆåŠŸï¼</span>`);
            } else {
                log(`<span class="error">\nâŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•</span>`);
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = message;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // åˆå§‹åŒ–
        initMap().catch(error => {
            log(`<span class="error">åˆå§‹åŒ–å¤±è´¥: ${error.message}</span>`);
            console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        });
    </script>
</body>
</html>
