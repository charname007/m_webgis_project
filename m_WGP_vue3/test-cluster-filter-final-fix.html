<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合要素过滤最终修复测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>聚合要素过滤最终修复测试</h1>
    
    <div class="controls">
        <button onclick="testZoomLevel(9)">测试缩放级别 9</button>
        <button onclick="testZoomLevel(11)">测试缩放级别 11</button>
        <button onclick="testZoomLevel(13)">测试缩放级别 13</button>
        <button onclick="testZoomLevel(15)">测试缩放级别 15</button>
        <button onclick="runFullTest()">运行完整测试</button>
        <span id="currentZoom">当前缩放级别: -</span>
    </div>
    
    <div id="map"></div>
    
    <div class="log" id="log">
        <div>=== 聚合要素过滤最终修复测试 ===</div>
        <div>等待地图初始化...</div>
    </div>

    <script type="module">
        import MapUtils from './src/components/mapUtils.js';

        // 测试数据 - 模拟不同等级的景区
        const testFeatures = [
            {
                type: 'Feature',
                properties: {
                    name: '5A级景区1',
                    level: '5A',
                    description: '国家级5A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.305, 30.5928]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '5A级景区2',
                    level: '5A',
                    description: '国家级5A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.315, 30.6028]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '4A级景区1',
                    level: '4A',
                    description: '国家级4A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.325, 30.6128]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '4A级景区2',
                    level: '4A',
                    description: '国家级4A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.335, 30.6228]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '3A级景区1',
                    level: '3A',
                    description: '国家级3A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.345, 30.6328]
                }
            },
            {
                type: 'Feature',
                properties: {
                    name: '3A级景区2',
                    level: '3A',
                    description: '国家级3A景区'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [114.355, 30.6428]
                }
            }
        ];

        // 配置基于缩放级别的过滤规则
        const zoomBasedConfig = {
            fieldName: 'level',
            fieldRange: {
                type: 'discrete',
                values: [
                    { value: '5A', minZoom: 10 },  // 5A级景区在缩放级别10+显示
                    { value: '4A', minZoom: 12 },  // 4A级景区在缩放级别12+显示
                    { value: '3A', minZoom: 14 }   // 3A级景区在缩放级别14+显示
                ]
            }
        };

        let mapUtils;
        let zoomLayer;

        // 初始化地图
        async function initMap() {
            const mapContainer = document.getElementById('map');
            
            mapUtils = new MapUtils(mapContainer);
            mapUtils.addBaseLayer();
            
            // 创建基于缩放级别的图层
            zoomLayer = mapUtils.createZoomBasedVectorLayer(
                zoomBasedConfig.fieldName,
                zoomBasedConfig.fieldRange,
                '景区图层',
                {
                    enableClustering: true,
                    clusterDistance: 40,
                    autoFitExtent: true
                }
            );
            
            // 添加测试要素
            const addResult = await mapUtils.addGeoJsonToLayer(zoomLayer, {
                type: 'FeatureCollection',
                features: testFeatures
            });
            
            log(`要素添加结果: ${addResult.addedCount} 个要素已添加`);
            
            // 监听缩放级别变化
            mapUtils.map.getView().on('change:resolution', () => {
                const currentZoom = mapUtils.map.getView().getZoom();
                document.getElementById('currentZoom').textContent = `当前缩放级别: ${currentZoom.toFixed(2)}`;
            });
            
            log('地图初始化完成，可以开始测试');
        }

        // 测试特定缩放级别
        async function testZoomLevel(zoomLevel) {
            log(`\n--- 测试缩放级别 ${zoomLevel} ---`);
            
            // 设置缩放级别
            mapUtils.setCenter([114.305, 30.5928], zoomLevel, { animate: false });
            
            // 等待地图更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 获取当前可见要素
            const visibleCount = mapUtils.getVisibleFeatureCount(zoomLayer);
            log(`缩放级别 ${zoomLevel}: ${visibleCount} 个要素可见`);
            
            // 验证聚合要素组成
            await validateClusterComposition(zoomLevel);
        }

        // 验证聚合要素组成
        async function validateClusterComposition(currentZoom) {
            const source = zoomLayer.getSource();
            const clusterFeatures = source.getFeatures();
            
            log(`聚合要素数量: ${clusterFeatures.length}`);
            
            let totalInvisibleInClusters = 0;
            let validationPassed = true;
            
            clusterFeatures.forEach((clusterFeature, index) => {
                const childFeatures = clusterFeature.get('features');
                if (childFeatures) {
                    const visibleChildCount = childFeatures.filter(child => 
                        child.get('visible') !== false
                    ).length;
                    
                    const invisibleChildCount = childFeatures.length - visibleChildCount;
                    totalInvisibleInClusters += invisibleChildCount;
                    
                    if (invisibleChildCount > 0) {
                        log(`<span class="warning">⚠️ 聚合要素 ${index} 包含 ${invisibleChildCount} 个不可见要素</span>`);
                        
                        // 显示不可见要素的详细信息
                        const invisibleLevels = {};
                        childFeatures.forEach(child => {
                            if (child.get('visible') === false) {
                                const level = child.get('level');
                                invisibleLevels[level] = (invisibleLevels[level] || 0) + 1;
                            }
                        });
                        log(`<span class="warning">   不可见要素等级分布: ${JSON.stringify(invisibleLevels)}</span>`);
                        validationPassed = false;
                    } else {
                        log(`<span class="success">✅ 聚合要素 ${index} 完全由可见要素组成</span>`);
                    }
                }
            });
            
            if (totalInvisibleInClusters > 0) {
                log(`<span class="error">❌ 发现 ${totalInvisibleInClusters} 个不可见要素混入聚合中</span>`);
                validationPassed = false;
            } else {
                log(`<span class="success">✅ 所有聚合要素完全由可见要素组成</span>`);
            }
            
            return validationPassed;
        }

        // 运行完整测试
        async function runFullTest() {
            log('\n=== 开始完整测试 ===');
            
            const testZoomLevels = [9, 11, 13, 15];
            let allTestsPassed = true;
            
            for (const zoomLevel of testZoomLevels) {
                const testPassed = await testZoomLevel(zoomLevel);
                if (!testPassed) {
                    allTestsPassed = false;
                }
            }
            
            if (allTestsPassed) {
                log(`<span class="success">\n🎉 所有测试通过！聚合要素过滤修复成功！</span>`);
            } else {
                log(`<span class="error">\n❌ 部分测试失败，需要进一步调试</span>`);
            }
        }

        // 日志函数
        function log(message) {
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = message;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 初始化
        initMap().catch(error => {
            log(`<span class="error">初始化失败: ${error.message}</span>`);
            console.error('初始化错误:', error);
        });
    </script>
</body>
</html>
