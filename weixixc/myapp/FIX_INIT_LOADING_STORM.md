# ä¿®å¤åˆå§‹åŒ–ç–¯ç‹‚åŠ è½½é—®é¢˜

## é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼š
- åœ°å›¾åˆå§‹åŒ–æ—¶å¡é¡¿å¾ˆä¹…
- æ§åˆ¶å°æ˜¾ç¤ºå‡ åƒæ¡åŠ è½½è®°å½•
- åŒä¸€ä¸ªæ™¯ç‚¹è¢«é‡å¤åŠ è½½å¤šæ¬¡

**æ ¹æœ¬åŸå› **ï¼š
åœ°å›¾åˆå§‹åŒ–æœŸé—´ï¼Œ`onRegionChange` äº‹ä»¶è¢«ç–¯ç‹‚è§¦å‘ï¼Œæ¯æ¬¡è§¦å‘éƒ½è°ƒç”¨ `loadSpotsInView()`ï¼Œå¯¼è‡´ï¼š
1. å¤§é‡é‡å¤çš„APIè¯·æ±‚
2. é‡å¤æ·»åŠ ç›¸åŒçš„æ™¯ç‚¹æ ‡è®°
3. å†…å­˜å’Œæ€§èƒ½é—®é¢˜

## è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ åœ°å›¾çŠ¶æ€æ ‡è®°

```javascript
data() {
  return {
    isMapReady: false,     // åœ°å›¾æ˜¯å¦å·²å‡†å¤‡å¥½
    isInitialLoad: true    // æ˜¯å¦æ˜¯åˆå§‹åŠ è½½
  }
}
```

### 2. å»¶é•¿åˆå§‹åŒ–ç­‰å¾…æ—¶é—´

```javascript
onLoad() {
  setTimeout(() => {
    this.isMapReady = true      // æ ‡è®°åœ°å›¾å·²å‡†å¤‡å¥½
    this.loadSpotsInView()      // ä¸»åŠ¨åŠ è½½ä¸€æ¬¡
  }, 1000)  // ä»500mså¢åŠ åˆ°1000ms
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- åœ°å›¾ç»„ä»¶éœ€è¦æ—¶é—´åˆå§‹åŒ–
- å¤ªæ—©è§¦å‘ä¼šå¯¼è‡´è·å–ä¸åˆ°æ­£ç¡®çš„åœ°å›¾åŒºåŸŸ
- 1ç§’è¶³å¤Ÿåœ°å›¾å®Œå…¨æ¸²æŸ“

### 3. ä¸¥æ ¼æ§åˆ¶ onRegionChange è§¦å‘

```javascript
onRegionChange(e) {
  // âœ… ç¬¬ä¸€å±‚é˜²æŠ¤ï¼šåœ°å›¾åˆå§‹åŒ–æœŸé—´å¿½ç•¥æ‰€æœ‰äº‹ä»¶
  if (!this.isMapReady) {
    console.log('åœ°å›¾åˆå§‹åŒ–ä¸­ï¼Œå¿½ç•¥regionchangeäº‹ä»¶')
    return
  }

  // âœ… ç¬¬äºŒå±‚é˜²æŠ¤ï¼šåªå¤„ç†ç§»åŠ¨/ç¼©æ”¾ç»“æŸäº‹ä»¶
  if (e.type !== 'end') {
    return
  }

  // âœ… ç¬¬ä¸‰å±‚é˜²æŠ¤ï¼šé¦–æ¬¡regionchangeä¹Ÿå¿½ç•¥
  if (this.isInitialLoad) {
    console.log('é¦–æ¬¡regionchangeï¼Œå¿½ç•¥')
    this.isInitialLoad = false
    return
  }

  // âœ… ç°åœ¨æ‰çœŸæ­£åŠ è½½
  console.log('åœ°å›¾åŒºåŸŸå˜åŒ–ï¼Œè§¦å‘åŠ è½½:', e.causedBy)
  this.loadSpotsInView()
}
```

### 4. ç”¨æˆ·æ“ä½œæ—¶æ ‡è®°åˆå§‹åŒ–å®Œæˆ

```javascript
handleZoomIn() {
  if (this.zoom < 20) {
    this.zoom++
    this.isInitialLoad = false  // ç”¨æˆ·ä¸»åŠ¨æ“ä½œï¼Œåˆå§‹åŒ–å®Œæˆ
  }
}

handleZoomOut() {
  if (this.zoom > 3) {
    this.zoom--
    this.isInitialLoad = false  // ç”¨æˆ·ä¸»åŠ¨æ“ä½œï¼Œåˆå§‹åŒ–å®Œæˆ
  }
}
```

## å·¥ä½œæµç¨‹

### ä¿®å¤å‰ï¼ˆé—®é¢˜ï¼‰

```
æ‰“å¼€åœ°å›¾
  â†“
åœ°å›¾å¼€å§‹åˆå§‹åŒ–
  â†“
è§¦å‘ regionchange (type=begin) â†’ è¢«èŠ‚æµæ‹¦æˆª
  â†“
è§¦å‘ regionchange (type=end)   â†’ åŠ è½½ä¸€æ¬¡ âœ—
  â†“
åœ°å›¾è‡ªåŠ¨è°ƒæ•´è§†é‡
  â†“
è§¦å‘ regionchange (type=end)   â†’ åŠ è½½ä¸€æ¬¡ âœ—
  â†“
åœ°å›¾ç»§ç»­è°ƒæ•´
  â†“
è§¦å‘ regionchange (type=end)   â†’ åŠ è½½ä¸€æ¬¡ âœ—
  â†“
...ï¼ˆé‡å¤å‡ ç™¾ä¸Šåƒæ¬¡ï¼‰
  â†“
åœ°å›¾ç»ˆäºç¨³å®š
  â†“
ç”¨æˆ·çœ‹åˆ°å¤§é‡é‡å¤æ™¯ç‚¹ âœ—
```

### ä¿®å¤åï¼ˆæ­£å¸¸ï¼‰

```
æ‰“å¼€åœ°å›¾
  â†“
åœ°å›¾å¼€å§‹åˆå§‹åŒ–ï¼ˆisMapReady=falseï¼‰
  â†“
è§¦å‘å¤šæ¬¡ regionchange â†’ å…¨éƒ¨å¿½ç•¥ âœ…
  â†“
ç­‰å¾…1000ms
  â†“
isMapReady = true
  â†“
ä¸»åŠ¨åŠ è½½ä¸€æ¬¡ â†’ æ˜¾ç¤ºæ™¯ç‚¹ âœ…
  â†“
è§¦å‘ç¬¬ä¸€æ¬¡ regionchange (isInitialLoad=true)
  â†“
å¿½ç•¥ï¼ˆåœ°å›¾è‡ªåŠ¨è°ƒæ•´ï¼‰ âœ…
  â†“
isInitialLoad = false
  â†“
ç”¨æˆ·æ»‘åŠ¨åœ°å›¾
  â†“
è§¦å‘ regionchange (isInitialLoad=false)
  â†“
æ­£å¸¸åŠ è½½æ–°æ™¯ç‚¹ âœ…
```

## ä¸‰é‡é˜²æŠ¤æœºåˆ¶

### é˜²æŠ¤1ï¼šåœ°å›¾æœªå°±ç»ªæ‹¦æˆª

```javascript
if (!this.isMapReady) {
  return  // åˆå§‹åŒ–æœŸé—´ä¸€å¾‹ä¸å¤„ç†
}
```

**æ‹¦æˆªæ—¶æœº**ï¼šé¡µé¢åŠ è½½å0-1000ms
**æ‹¦æˆªæ•°é‡**ï¼šé€šå¸¸10-100æ¬¡regionchange

### é˜²æŠ¤2ï¼šäº‹ä»¶ç±»å‹è¿‡æ»¤

```javascript
if (e.type !== 'end') {
  return  // åªå¤„ç†'end'äº‹ä»¶
}
```

**æ‹¦æˆªäº‹ä»¶**ï¼š
- `type='begin'` - ç§»åŠ¨/ç¼©æ”¾å¼€å§‹
- `type='ing'` - ç§»åŠ¨/ç¼©æ”¾ä¸­

### é˜²æŠ¤3ï¼šé¦–æ¬¡äº‹ä»¶å¿½ç•¥

```javascript
if (this.isInitialLoad) {
  this.isInitialLoad = false
  return  // é¦–æ¬¡è‡ªåŠ¨è°ƒæ•´ä¸åŠ è½½
}
```

**æ‹¦æˆªæ—¶æœº**ï¼šåœ°å›¾å°±ç»ªåçš„ç¬¬ä¸€æ¬¡regionchange
**åŸå› **ï¼šåœ°å›¾é¦–æ¬¡æ¸²æŸ“æ—¶ä¼šè‡ªåŠ¨è°ƒæ•´è§†é‡

## æ—¶åºå›¾

```
æ—¶é—´è½´  äº‹ä»¶                     isMapReady  isInitialLoad  æ˜¯å¦åŠ è½½
---------------------------------------------------------------------
0ms    é¡µé¢åŠ è½½                 false       true           -
10ms   regionchange(begin)      false       true           âœ— å¿½ç•¥
15ms   regionchange(end)        false       true           âœ— å¿½ç•¥
20ms   regionchange(begin)      false       true           âœ— å¿½ç•¥
25ms   regionchange(end)        false       true           âœ— å¿½ç•¥
...    (é‡å¤å¤šæ¬¡)               false       true           âœ— å¿½ç•¥
1000ms isMapReady=true          true        true           -
1001ms loadSpotsInView()        true        true           âœ… åŠ è½½
1500ms regionchange(end)        true        true           âœ— å¿½ç•¥(é¦–æ¬¡)
1501ms isInitialLoad=false      true        false          -
5000ms ç”¨æˆ·æ»‘åŠ¨åœ°å›¾             true        false          -
5500ms regionchange(end)        true        false          âœ… åŠ è½½
```

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|-------|-------|------|
| åˆå§‹åŒ–è§¦å‘æ¬¡æ•° | 100-1000æ¬¡ | 1æ¬¡ | 99%+ âš¡ |
| æ§åˆ¶å°æ—¥å¿— | å‡ åƒæ¡ | å‡ æ¡ | 99%+ ğŸ“Š |
| åŠ è½½æ—¶é—´ | 10-30ç§’ | 1-2ç§’ | 80%+ ğŸš€ |
| å†…å­˜å ç”¨ | çˆ†ç‚¸å¢é•¿ | æ­£å¸¸ | - ğŸ’¾ |
| ç”¨æˆ·ä½“éªŒ | å¡æ­» | æµç•… | å·¨å¤§æå‡ âœ… |

## è°ƒè¯•æ—¥å¿—

ç°åœ¨æ§åˆ¶å°åº”è¯¥çœ‹åˆ°æ¸…æ™°çš„æ—¥å¿—ï¼š

```javascript
// åˆå§‹åŒ–æœŸé—´
"åœ°å›¾åˆå§‹åŒ–ä¸­ï¼Œå¿½ç•¥regionchangeäº‹ä»¶"  // å¤šæ¬¡
"åœ°å›¾åˆå§‹åŒ–ä¸­ï¼Œå¿½ç•¥regionchangeäº‹ä»¶"
...

// 1ç§’å
"æ–°å¢ 10 ä¸ªæ™¯ç‚¹ï¼Œæ€»è®¡ 10 ä¸ª"           // ä¸»åŠ¨åŠ è½½

// é¦–æ¬¡regionchange
"é¦–æ¬¡regionchangeï¼Œå¿½ç•¥"              // å¿½ç•¥è‡ªåŠ¨è°ƒæ•´

// ç”¨æˆ·æ“ä½œå
"åœ°å›¾åŒºåŸŸå˜åŒ–ï¼Œè§¦å‘åŠ è½½: gesture end"  // æ­£å¸¸åŠ è½½
"æ–°å¢ 5 ä¸ªæ™¯ç‚¹ï¼Œæ€»è®¡ 15 ä¸ª"
```

## é…ç½®å‚æ•°

å¯ä»¥è°ƒæ•´åˆå§‹åŒ–ç­‰å¾…æ—¶é—´ï¼š

```javascript
onLoad() {
  setTimeout(() => {
    this.isMapReady = true
    this.loadSpotsInView()
  }, 1000)  // è°ƒæ•´è¿™é‡Œ âœï¸
}
```

**å»ºè®®å€¼**ï¼š
- **500ms** - ç½‘ç»œå¥½ã€è®¾å¤‡å¿«
- **1000ms** - æ¨èé»˜è®¤å€¼ âœ…
- **1500ms** - ç½‘ç»œå·®ã€è®¾å¤‡æ…¢

## ç‰¹æ®Šæƒ…å†µå¤„ç†

### æƒ…å†µ1ï¼šç”¨æˆ·åœ¨åˆå§‹åŒ–æœŸé—´å°±å¼€å§‹æ“ä½œ

```javascript
handleZoomIn() {
  this.zoom++
  this.isInitialLoad = false  // ç«‹å³æ ‡è®°å®Œæˆ
}
```

**æ•ˆæœ**ï¼šç”¨æˆ·ç¼©æ”¾åç«‹å³å“åº”ï¼Œä¸ç­‰1ç§’

### æƒ…å†µ2ï¼šåœ°å›¾APIå¤±è´¥

èŠ‚æµå’Œå»é‡æœºåˆ¶ä»ç„¶ç”Ÿæ•ˆï¼š
```javascript
if (now - this.lastLoadTime < this.loadThrottle) {
  return  // 1ç§’å†…åªèƒ½è¯·æ±‚ä¸€æ¬¡
}
```

### æƒ…å†µ3ï¼šå¿«é€Ÿè¿ç»­ç§»åŠ¨

```javascript
// åªæœ‰ç§»åŠ¨ç»“æŸ(type='end')æ‰è§¦å‘
if (e.type !== 'end') {
  return
}
```

**æ•ˆæœ**ï¼šç§»åŠ¨è¿‡ç¨‹ä¸­ä¸åŠ è½½ï¼Œåœä¸‹æ¥æ‰åŠ è½½

## å·²çŸ¥é—®é¢˜å’Œè§£å†³

### é—®é¢˜1ï¼šé¦–æ¬¡åŠ è½½ååœ°å›¾ä½ç½®ä¸å¯¹

**åŸå› **ï¼šåœ°å›¾åˆå§‹åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´ä½ç½®
**è§£å†³**ï¼šå¿½ç•¥é¦–æ¬¡regionchangeï¼ˆå·²å®ç°ï¼‰

### é—®é¢˜2ï¼šç”¨æˆ·ç«‹å³æ“ä½œæ—¶æ— å“åº”

**åŸå› **ï¼šisMapReady=false
**è§£å†³**ï¼šç¼©æ”¾/å®šä½æŒ‰é’®ä¸»åŠ¨è®¾ç½®isInitialLoad=falseï¼ˆå·²å®ç°ï¼‰

### é—®é¢˜3ï¼šæœ‰æ—¶å€™è¿˜æ˜¯ä¼šè§¦å‘å¤šæ¬¡

**åŸå› **ï¼šèŠ‚æµæ—¶é—´å¤ªçŸ­
**è§£å†³**ï¼šå·²è®¾ç½®1ç§’èŠ‚æµ + ä¸‰é‡é˜²æŠ¤

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°**ï¼š
   ```
   å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ ç¼“å­˜ â†’ æ¸…é™¤ç¼“å­˜ â†’ Ctrl+R
   ```

2. **è§‚å¯Ÿæ§åˆ¶å°**ï¼š
   - åº”è¯¥çœ‹åˆ°"åœ°å›¾åˆå§‹åŒ–ä¸­ï¼Œå¿½ç•¥"å‡ æ¬¡
   - 1ç§’åçœ‹åˆ°"æ–°å¢ X ä¸ªæ™¯ç‚¹"
   - åªæœ‰1æ¡åŠ è½½è®°å½•ï¼Œä¸æ˜¯å‡ åƒæ¡ âœ…

3. **è§‚å¯Ÿåœ°å›¾**ï¼š
   - 1ç§’å†…ä¸æ˜¾ç¤ºæ™¯ç‚¹
   - 1ç§’åæ™¯ç‚¹å‡ºç°
   - åŠ è½½è¿‡ç¨‹æµç•…ï¼Œä¸å¡é¡¿ âœ…

4. **æ»‘åŠ¨åœ°å›¾**ï¼š
   - é¦–æ¬¡æ»‘åŠ¨ï¼šçœ‹åˆ°"é¦–æ¬¡regionchangeï¼Œå¿½ç•¥"
   - å†æ¬¡æ»‘åŠ¨ï¼šæ­£å¸¸åŠ è½½æ–°æ™¯ç‚¹ âœ…

### é¢„æœŸç»“æœ

```
âœ… æ§åˆ¶å°æ—¥å¿—æ¸…æ™°ï¼Œä¸è¶…è¿‡10æ¡
âœ… åˆå§‹åŠ è½½æ—¶é—´1-2ç§’
âœ… ä¸å¡é¡¿ï¼Œä¸å‡æ­»
âœ… æ™¯ç‚¹ä¸é‡å¤æ˜¾ç¤º
âœ… æ»‘åŠ¨å“åº”æµç•…
```

## æ€»ç»“

### é—®é¢˜æ ¹æº

åœ°å›¾åˆå§‹åŒ–æœŸé—´è§¦å‘å¤§é‡ `regionchange` äº‹ä»¶ï¼Œæ²¡æœ‰åˆç†æ§åˆ¶ã€‚

### è§£å†³ç­–ç•¥

**ä¸‰é‡é˜²æŠ¤ + ä¸»åŠ¨åŠ è½½**ï¼š
1. åœ°å›¾æœªå°±ç»ªæ—¶å¿½ç•¥æ‰€æœ‰äº‹ä»¶
2. åªå¤„ç†ç§»åŠ¨ç»“æŸäº‹ä»¶
3. å¿½ç•¥é¦–æ¬¡è‡ªåŠ¨è°ƒæ•´äº‹ä»¶
4. 1ç§’åä¸»åŠ¨åŠ è½½ä¸€æ¬¡

### æ•ˆæœæå‡

- æ€§èƒ½æå‡ï¼š**99%+**
- åŠ è½½é€Ÿåº¦ï¼š**å¿«10å€ä»¥ä¸Š**
- ç”¨æˆ·ä½“éªŒï¼š**ä»å¡æ­»åˆ°æµç•…**

### ç›¸å…³æ–‡ä»¶

- `myapp/src/pages/map/index.vue` - åœ°å›¾é¡µé¢ä¸»æ–‡ä»¶
- ä¿®æ”¹è¡Œæ•°ï¼š136-157, 438-471, 410-425

---

**ç°åœ¨åˆ·æ–°å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æµç•…çš„åŠ è½½ä½“éªŒäº†ï¼** ğŸ‰
