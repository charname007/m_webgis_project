# 地图小程序实现总结

## 完成的工作

### 1. 项目基础配置

#### pages.json 修改
- 将启动页面从 `pages/index/index` 改为 `pages/map/index`
- 配置地图页面样式:
  - 导航栏标题: "景区地图"
  - 导航栏背景色: #4a90e2
  - 导航栏文字样式: 白色

#### manifest.json 修改
- 添加微信小程序位置权限配置:
  ```json
  "permission": {
    "scope.userLocation": {
      "desc": "获取您的位置信息用于显示附近景点"
    }
  },
  "requiredPrivateInfos": ["getLocation"]
  ```

### 2. 工具类文件

#### utils/config.js
- API配置管理
- 支持生产环境和开发环境URL切换
- 包含以下API配置:
  - Spring Boot API (端口8082): 景点数据API
  - FastAPI (端口8001): AI查询服务
  - 各类API端点: 景点列表、搜索、增删改查、AI查询等

#### utils/request.js
- 网络请求封装
- 提供统一的请求接口(GET/POST/PUT/DELETE)
- 自动添加通用请求头
- 统一错误处理
- 支持请求/响应拦截

### 3. 全局配置

#### App.vue
- 应用启动时检查更新
- 获取并保存系统信息到globalData
- 设置全局样式
- 配置全局API地址

#### uni.scss
- 定义全局SCSS变量:
  - 颜色系统 (主色、成功、警告、错误等)
  - 间距系统 (xs/sm/md/lg/xl)
  - 阴影效果 (light/medium/heavy)
  - 字体大小 (xs/sm/base/lg/xl/2xl)

### 4. 地图页面实现

#### pages/map/index.vue
完整的地图页面实现,包含以下功能:

**基础地图显示**
- 使用微信小程序原生 `<map>` 组件
- 默认中心点: 武汉大学 (114.353, 30.531)
- 默认缩放级别: 12
- 支持缩放范围: 3-20

**交互控件**
- 缩放控件 (+/-)
  - 位置: 右侧中央
  - 样式: 白色背景圆角按钮
  - 功能: 放大/缩小地图
- 定位按钮 (📍)
  - 位置: 缩放控件下方
  - 功能: 定位到当前位置
  - 自动请求位置权限

**信息显示**
- 实时显示当前缩放级别
- 实时显示地图中心坐标
- 位置: 左上角半透明卡片

**状态管理**
- 响应式数据绑定 (Vue 3 Composition API)
- 地图拖拽后自动更新中心点
- 缩放后自动更新缩放级别

**权限处理**
- 自动请求位置权限
- 权限被拒绝时引导用户开启
- 定位失败时友好提示

**事件处理**
- 地图区域变化事件 (regionchange)
- 地图点击事件 (tap)
- 标记点击事件 (markertap)

## 技术栈

- **框架**: uni-app (Vue 3)
- **地图**: 微信小程序原生 map 组件
- **UI层**: cover-view + cover-image
- **样式**: SCSS with rpx单位
- **API**: Vue 3 Composition API

## 当前状态

### ✅ 已完成
1. 基础项目结构搭建
2. API配置和网络请求封装
3. 地图基础显示功能
4. 地图交互控件
5. 位置权限处理
6. 地图信息实时显示

### 🚧 待实现功能

#### 1. 景点数据加载
- 从后端API获取景点数据
- 在地图上显示景点标记
- 自定义标记图标

#### 2. 标记聚类
- 集成 supercluster 库
- 根据缩放级别动态聚类
- 显示聚类点数量

#### 3. 景点搜索
- 搜索面板UI
- 关键词搜索
- 搜索结果列表
- 点击结果定位到地图

#### 4. 景点详情
- 详情弹窗
- 显示景点信息(名称、等级、地址、评分、票价等)
- 图片轮播
- 路线规划

#### 5. AI智能查询
- AI查询输入框
- 自然语言查询
- 查询结果展示
- 地图联动

#### 6. 景点编辑
- 添加新景点
- 编辑已有景点
- 删除景点
- 表单验证

## 下一步建议

1. **测试当前实现**
   ```bash
   npm run dev:mp-weixin
   ```
   使用微信开发者工具打开项目,测试地图基础功能

2. **配置后端API地址**
   - 修改 `src/utils/config.js` 中的API地址
   - 确保后端服务正常运行

3. **配置小程序AppID**
   - 修改 `src/manifest.json` 中的 appid
   - 在微信公众平台配置合法域名

4. **实现景点标记显示**
   - 创建景点数据接口调用
   - 在地图上显示标记点
   - 实现标记点点击事件

5. **逐步完成其他功能模块**
   - 按优先级实现待办功能
   - 保持代码结构清晰
   - 注意性能优化

## 注意事项

1. **地图组件层级**
   - `<map>` 组件是原生组件,层级最高
   - 覆盖在地图上的元素必须使用 `<cover-view>` 和 `<cover-image>`
   - 普通 `<view>` 会被地图遮挡

2. **坐标系统**
   - 微信小程序使用GCJ-02坐标系(火星坐标系)
   - 如果后端使用WGS84坐标,需要进行坐标转换
   - 定位时使用 `type: 'gcj02'`

3. **性能优化**
   - 大量标记点时需要使用聚类
   - 避免频繁更新地图
   - 图片需要压缩优化

4. **权限处理**
   - 位置权限是必需的
   - 需要友好的权限引导
   - 处理权限拒绝的情况

## 文件清单

```
myapp/src/
├── App.vue                 # 应用入口
├── main.js                 # 程序入口
├── pages.json              # 页面配置
├── manifest.json           # 应用配置
├── uni.scss                # 全局样式变量
├── pages/
│   └── map/
│       └── index.vue       # 地图页面(核心)
└── utils/
    ├── config.js           # API配置
    └── request.js          # 网络请求
```

## 测试步骤

1. 安装依赖
   ```bash
   cd myapp
   npm install
   ```

2. 启动开发服务器
   ```bash
   npm run dev:mp-weixin
   ```

3. 使用微信开发者工具导入项目
   - 打开微信开发者工具
   - 导入项目: 选择 `myapp/dist/dev/mp-weixin` 目录
   - 查看地图显示效果

4. 测试功能
   - 地图是否正常显示
   - 拖拽地图,检查坐标更新
   - 点击缩放按钮
   - 点击定位按钮
   - 检查地图信息显示

## 遇到问题?

1. **地图不显示**
   - 检查 manifest.json 中的 appid 是否正确
   - 检查位置权限是否授予
   - 查看控制台错误信息

2. **定位失败**
   - 检查真机是否开启定位服务
   - 检查小程序是否有位置权限
   - 开发工具需要在设置中开启位置模拟

3. **样式问题**
   - 确认使用 rpx 单位
   - 检查 uni.scss 是否正确引入
   - cover-view 样式支持有限,避免使用复杂样式

4. **API调用失败**
   - 检查 API 地址配置
   - 在小程序后台配置合法域名
   - 开发时可以在微信开发者工具中关闭域名校验
